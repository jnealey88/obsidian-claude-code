var Z=Object.create;var M=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var se=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty;var ne=(g,t)=>{for(var e in t)M(g,e,{get:t[e],enumerable:!0})},N=(g,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of te(t))!ie.call(g,i)&&i!==e&&M(g,i,{get:()=>t[i],enumerable:!(s=ee(t,i))||s.enumerable});return g};var W=(g,t,e)=>(e=g!=null?Z(se(g)):{},N(t||!g||!g.__esModule?M(e,"default",{value:g,enumerable:!0}):e,g)),ae=g=>N(M({},"__esModule",{value:!0}),g);var de={};ne(de,{default:()=>H});module.exports=ae(de);var Y=require("obsidian");var O={claudePath:"claude",defaultAllowedTools:["Read","Glob","Grep","Edit","Write","Bash","WebFetch","WebSearch","Task","AskUserQuestion"],maxTurns:25,skillsFolder:".claude/skills",includeCurrentNote:!0,maxContextFiles:10,maxContextLength:5e4,excludeFolders:[".obsidian",".claude-sessions","node_modules"],showToolCalls:!0,streamResponses:!0,defaultPanelPosition:"right",autoSaveSessions:!0,sessionStoragePath:".claude-sessions",maxSessionHistory:50};var oe={Read:{name:"Read",category:"read",icon:"\u{1F4D6}",color:"#4CAF50",description:"Reading file"},Edit:{name:"Edit",category:"write",icon:"\u270F\uFE0F",color:"#FF9800",description:"Editing file"},Write:{name:"Write",category:"write",icon:"\u{1F4DD}",color:"#FF9800",description:"Writing file"},Glob:{name:"Glob",category:"search",icon:"\u{1F50D}",color:"#2196F3",description:"Finding files"},Grep:{name:"Grep",category:"search",icon:"\u{1F50E}",color:"#2196F3",description:"Searching content"},Bash:{name:"Bash",category:"execute",icon:"\u{1F4BB}",color:"#9C27B0",description:"Running command"},WebFetch:{name:"WebFetch",category:"web",icon:"\u{1F310}",color:"#00BCD4",description:"Fetching URL"},WebSearch:{name:"WebSearch",category:"web",icon:"\u{1F50D}",color:"#00BCD4",description:"Searching web"},Task:{name:"Task",category:"agent",icon:"\u{1F916}",color:"#E91E63",description:"Running agent"},TodoWrite:{name:"TodoWrite",category:"write",icon:"\u2705",color:"#8BC34A",description:"Managing todos"},AskUserQuestion:{name:"AskUserQuestion",category:"agent",icon:"\u2753",color:"#FFC107",description:"Asking question"}};function q(g){return oe[g]||{name:g,category:"execute",icon:"\u2699\uFE0F",color:"#757575",description:"Running tool"}}var b=require("obsidian");var E="claude-chat-panel",L=class extends b.ItemView{constructor(e,s){super(e);this.currentSessionId=null;this.selectedSkill="";this.currentResponseEl=null;this.accumulatedContent="";this.showingHistory=!1;this.includeFileContext=!0;this.includeWebContext=!0;this.activeToolCalls=new Map;this.plugin=s}getViewType(){return E}getDisplayText(){return"Claude Chat"}getIcon(){return"message-circle"}async onOpen(){let e=this.contentEl;e.empty(),e.addClass("claude-chat-container"),this.createHeader(e),this.historyPanelEl=e.createDiv("claude-history-panel claude-hidden"),this.mainContentEl=e.createDiv("claude-main-content"),this.createSkillBar(this.mainContentEl),this.messagesEl=this.mainContentEl.createDiv("claude-messages"),this.createInputArea(this.mainContentEl),this.setupEventListeners(),await this.initializeSession()}createHeader(e){let s=e.createDiv("claude-chat-header"),i=s.createDiv("claude-header-left"),n=i.createEl("button",{cls:"claude-btn claude-btn-icon",attr:{"aria-label":"Chat history"}});n.innerHTML="\u2630",n.addEventListener("click",()=>this.toggleHistory()),i.createEl("span",{text:"Claude Chat",cls:"claude-header-title"}),this.msgCountEl=i.createEl("span",{cls:"claude-msg-count"}),s.createDiv("claude-header-controls").createEl("button",{text:"+ New",cls:"claude-btn claude-btn-secondary claude-btn-small"}).addEventListener("click",()=>this.startNewSession())}updateMessageCount(){let e=this.plugin.sessionManager.getSession(this.currentSessionId);if(e&&this.msgCountEl){let s=e.messages.length,i=s>20,n=s>40;this.msgCountEl.textContent=`${s} msgs`,this.msgCountEl.toggleClass("warning",i&&!n),this.msgCountEl.toggleClass("danger",n),this.msgCountEl.title=n?"Conversation is very long - consider starting a new chat":i?"Conversation is getting long":""}}toggleHistory(){this.showingHistory=!this.showingHistory,this.showingHistory?(this.historyPanelEl.removeClass("claude-hidden"),this.mainContentEl.addClass("claude-hidden"),this.renderHistoryPanel()):(this.historyPanelEl.addClass("claude-hidden"),this.mainContentEl.removeClass("claude-hidden"))}renderHistoryPanel(){this.historyPanelEl.empty(),this.historyPanelEl.createDiv("claude-history-header").createEl("span",{text:"Chat History",cls:"claude-history-title"});let s=this.historyPanelEl.createDiv("claude-history-list"),i=this.plugin.sessionManager.getAllSessions();if(i.length===0){s.createDiv({text:"No previous chats",cls:"claude-history-empty"});return}i.sort((n,a)=>a.createdAt-n.createdAt),i.forEach(n=>{var m;let a=s.createDiv({cls:`claude-history-item ${n.id===this.currentSessionId?"active":""}`}),o=a.createDiv("claude-history-info"),c=n.messages.find(h=>h.role==="user"),r=((m=c==null?void 0:c.content)==null?void 0:m.substring(0,50))||"New chat";o.createDiv({text:r+(r.length>=50?"...":""),cls:"claude-history-preview"});let u=new Date(n.createdAt).toLocaleDateString(void 0,{month:"short",day:"numeric"});o.createDiv({text:`${u} \xB7 ${n.messages.length} msgs`,cls:"claude-history-meta"}),a.addEventListener("click",()=>{this.loadSession(n.id),this.toggleHistory()});let d=a.createEl("button",{cls:"claude-history-delete",attr:{"aria-label":"Delete chat"}});d.innerHTML="\xD7",d.addEventListener("click",h=>{h.stopPropagation(),this.deleteSession(n.id)})})}deleteSession(e){this.plugin.sessionManager.deleteSession(e),e===this.currentSessionId&&this.startNewSession(),this.renderHistoryPanel()}createSkillBar(e){let s=e.createDiv("claude-skill-bar"),i=s.createSpan({cls:"claude-skill-label"});i.textContent="Mode:",this.skillSelectEl=s.createEl("select",{cls:"claude-skill-select"}),this.plugin.skillLoader.getSkills().forEach(o=>{let c=this.skillSelectEl.createEl("option",{text:`${o.icon} ${o.name}`,value:o.id});c.title=o.description}),this.skillSelectEl.addEventListener("change",()=>{this.selectedSkill=this.skillSelectEl.value,this.updateSkillHint()});let a=s.createDiv("claude-skill-hint");a.id="skill-hint",this.updateSkillHint()}updateSkillHint(){let e=this.contentEl.querySelector("#skill-hint");if(e){let i=this.plugin.skillLoader.getSkills().find(n=>n.id===this.selectedSkill);e.textContent=(i==null?void 0:i.description)||""}}createInputArea(e){let s=e.createDiv("claude-input-wrapper"),i=s.createDiv("claude-context-bar");this.createContextToggle(i),this.inputEl=s.createEl("textarea",{placeholder:"Ask Claude anything...",cls:"claude-input"}),this.inputEl.addEventListener("keydown",a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),this.sendMessage())});let n=s.createDiv("claude-btn-container");this.sendBtn=n.createEl("button",{text:"Send",cls:"claude-btn claude-btn-primary"}),this.sendBtn.addEventListener("click",()=>this.sendMessage()),this.abortBtn=n.createEl("button",{text:"Stop",cls:"claude-btn claude-btn-danger claude-hidden"}),this.abortBtn.addEventListener("click",()=>this.abortRequest())}setupEventListeners(){this.plugin.cliService.on("message",e=>{this.handleStreamMessage(e)}),this.plugin.cliService.on("partial",e=>{this.updateStreamingMessage(e)})}async initializeSession(){let e=this.plugin.sessionManager.getActiveSession();if(!e){let s=this.plugin.sessionManager.getAllSessions();s.length>0?(e=s[0],this.plugin.sessionManager.setActiveSession(e.id)):e=this.plugin.sessionManager.createSession()}this.currentSessionId=e.id,this.renderMessages(e.messages),this.updateMessageCount()}async sendMessage(){var a;let e=this.inputEl.value.trim();if(!e)return;if(this.plugin.cliService.isRunning()){if(this.plugin.cliService.queueInput(e)){let c={id:this.generateId(),role:"user",content:e,timestamp:Date.now()};this.plugin.sessionManager.addMessage(this.currentSessionId,c),this.appendMessage(c),this.inputEl.value="",this.updateMessageCount(),this.appendQueuedIndicator()}return}let s=e,i;if(this.selectedSkill){let o=await this.plugin.skillLoader.getSkillContent(this.selectedSkill);o&&(i=o),s=`/${this.selectedSkill} ${e}`}let n={id:this.generateId(),role:"user",content:e,timestamp:Date.now()};this.plugin.sessionManager.addMessage(this.currentSessionId,n),this.appendMessage(n),this.inputEl.value="",this.setLoadingState(!0),this.currentResponseEl=null,this.accumulatedContent="",this.appendThinking();try{let o="";if(this.includeFileContext&&(o=await this.plugin.contextProvider.getVaultAwareness(!0)),this.includeWebContext){let l=await this.plugin.contextProvider.getWebViewerContext();l&&(o+=`

--- Web Page Context ---
${l.content}
--- End Web Page ---

`)}let c=this.plugin.sessionManager.getSession(this.currentSessionId);console.log("[Claude Plugin] Executing with lightweight context, file awareness:",this.includeFileContext,"web context:",this.includeWebContext,"skill:",this.selectedSkill||"none");let r=await this.plugin.cliService.execute({prompt:o+s,sessionId:c==null?void 0:c.claudeSessionId,appendSystemPrompt:i});if(console.log("[Claude Plugin] Execution result:",r.success,(a=r.finalContent)==null?void 0:a.substring(0,50)),r.sessionId&&this.plugin.sessionManager.setClaudeSessionId(this.currentSessionId,r.sessionId),this.accumulatedContent){let l={id:this.generateId(),role:"assistant",content:this.accumulatedContent,timestamp:Date.now()};this.plugin.sessionManager.addMessage(this.currentSessionId,l)}this.finalizeStreamingMessage(),this.updateMessageCount()}catch(o){this.showError(o.message)}finally{this.setLoadingState(!1);let o=this.plugin.cliService.getAndClearQueuedInput();o&&(this.removeQueuedIndicator(),setTimeout(()=>{this.inputEl.value=o,this.sendMessage()},100))}}handleStreamMessage(e){if(e.type==="thinking"&&e.content){this.removeThinking();let s=typeof e.content=="string"?e.content:"";this.appendThinkingContent(s),this.finalizeCurrentResponse()}if(e.type==="assistant"&&e.content){this.removeThinking();let s=typeof e.content=="string"?e.content:"";this.currentResponseEl||this.createResponseElement(),this.accumulatedContent=s}e.type==="tool_use"&&this.plugin.settings.showToolCalls&&(this.removeThinking(),this.finalizeCurrentResponse(),this.appendToolCall(e.name||"unknown",e.input||{},e.id),this.appendThinking()),e.type==="tool_result"&&this.handleToolResult(e),e.type==="result"&&(this.removeThinking(),this.activeToolCalls.clear())}createResponseElement(){this.currentResponseEl=this.messagesEl.createDiv({cls:"claude-message claude-message-assistant streaming"}),this.currentResponseEl.createDiv("claude-message-content");let e=this.currentResponseEl.createEl("button",{cls:"claude-copy-btn",attr:{"aria-label":"Copy to clipboard"}});e.innerHTML="\u{1F4CB}",e.addEventListener("click",()=>{navigator.clipboard.writeText(this.accumulatedContent).then(()=>{e.innerHTML="\u2713",setTimeout(()=>{e.innerHTML="\u{1F4CB}"},2e3)})}),this.messagesEl.scrollTop=this.messagesEl.scrollHeight}finalizeCurrentResponse(){this.currentResponseEl&&(this.currentResponseEl.removeClass("streaming"),this.currentResponseEl=null)}updateStreamingMessage(e){var i;this.currentResponseEl||(this.removeThinking(),this.createResponseElement());let s=(i=this.currentResponseEl)==null?void 0:i.querySelector(".claude-message-content");s&&(s.empty(),b.MarkdownRenderer.render(this.plugin.app,e,s,"",this.plugin),this.accumulatedContent=e,this.messagesEl.scrollTop=this.messagesEl.scrollHeight)}finalizeStreamingMessage(){this.finalizeCurrentResponse();let e=this.messagesEl.querySelector(".claude-message.streaming");e&&e.removeClass("streaming")}appendMessage(e){let s=this.messagesEl.createDiv({cls:`claude-message claude-message-${e.role} ${e.isStreaming?"streaming":""}`}),i=s.createDiv("claude-message-content");if(e.content&&b.MarkdownRenderer.render(this.plugin.app,e.content,i,"",this.plugin),e.role==="assistant"){let n=s.createEl("button",{cls:"claude-copy-btn",attr:{"aria-label":"Copy to clipboard"}});n.innerHTML="\u{1F4CB}",n.addEventListener("click",()=>{let a=e.content||"";navigator.clipboard.writeText(a).then(()=>{n.innerHTML="\u2713",setTimeout(()=>{n.innerHTML="\u{1F4CB}"},2e3)})})}this.messagesEl.scrollTop=this.messagesEl.scrollHeight}appendToolCall(e,s,i){let n=q(e),a=this.messagesEl.createDiv("claude-tool-call");a.addClass(`claude-tool-${n.category}`);let o=i||`tool-${Date.now()}`;a.dataset.toolId=o;let c=a.createSpan({cls:"claude-tool-icon"});c.textContent=n.icon,c.style.setProperty("--tool-color",n.color);let r=a.createSpan({cls:"claude-tool-spinner"});r.innerHTML="\u25CC";let l=a.createEl("details",{cls:"claude-tool-details"}),u=l.createEl("summary"),d=u.createSpan({cls:"claude-tool-name-badge"});d.textContent=e,d.style.setProperty("--tool-color",n.color);let m=u.createSpan({cls:"claude-tool-summary-text"});m.textContent=this.getToolSummary(e,s);let h=l.createEl("pre",{cls:"claude-tool-input"});if(h.textContent=JSON.stringify(s,null,2),e==="Edit"&&s.old_string&&s.new_string){let f=l.createDiv("claude-tool-diff");this.renderDiff(f,s.old_string,s.new_string)}this.activeToolCalls.set(o,{id:o,name:e,input:s,startTime:Date.now(),element:a}),this.messagesEl.scrollTop=this.messagesEl.scrollHeight}handleToolResult(e){let s=e.id;if(!s)return;let i=this.activeToolCalls.get(s);if(i){let n=i.element;n.removeClass("claude-tool-running"),n.addClass(e.is_error?"claude-tool-error":"claude-tool-complete");let a=n.querySelector(".claude-tool-spinner");a&&a.remove();let o=Date.now()-i.startTime,c=n.createSpan({cls:"claude-tool-duration"});c.textContent=o>1e3?`${(o/1e3).toFixed(1)}s`:`${o}ms`;let r=n.createSpan({cls:"claude-tool-result-indicator"});if(r.textContent=e.is_error?"\u2717":"\u2713",e.is_error&&e.output){let l=n.querySelector(".claude-tool-details");if(l){let u=l.createDiv("claude-tool-error-output");u.textContent=typeof e.output=="string"?e.output:JSON.stringify(e.output)}}this.activeToolCalls.delete(s)}}renderDiff(e,s,i){e.empty(),e.createDiv("claude-diff-header").createSpan({text:"Changes",cls:"claude-diff-title"});let a=e.createDiv("claude-diff-content"),o=s.split(`
`),c=i.split(`
`);if(o.length>0&&s.trim()){let r=a.createDiv("claude-diff-removed");r.createSpan({text:"\u2212",cls:"claude-diff-marker"});let l=r.createEl("code");l.textContent=s}if(c.length>0&&i.trim()){let r=a.createDiv("claude-diff-added");r.createSpan({text:"+",cls:"claude-diff-marker"});let l=r.createEl("code");l.textContent=i}}getToolSummary(e,s){var a,o,c;let i=s.file_path,n=(i==null?void 0:i.split("/").pop())||"file";switch(e){case"Read":return n;case"Edit":return n;case"Write":return n;case"Glob":return`${s.pattern||"*"}`;case"Grep":return`"${((a=s.pattern)==null?void 0:a.substring(0,30))||"..."}"`;case"Bash":let r=s.command||"";return r.substring(0,50)+(r.length>50?"...":"");case"WebFetch":try{return new URL(s.url).hostname}catch(u){return"URL"}case"WebSearch":return`"${((o=s.query)==null?void 0:o.substring(0,30))||"..."}"`;case"Task":return((c=s.description)==null?void 0:c.substring(0,40))||"subtask";case"TodoWrite":let l=s.todos;return l?`${l.length} items`:"todos";default:return""}}appendThinking(){let e=this.messagesEl.createDiv("claude-thinking");return e.createSpan({text:"\u{1F9E0}",cls:"claude-thinking-icon"}),e.createSpan({text:"Thinking...",cls:"claude-thinking-text"}),this.messagesEl.scrollTop=this.messagesEl.scrollHeight,e}appendThinkingContent(e){let i=this.messagesEl.createDiv("claude-thinking-block").createEl("details",{cls:"claude-thinking-details"}),n=i.createEl("summary",{cls:"claude-thinking-summary"});n.createSpan({text:"\u{1F9E0}",cls:"claude-thinking-icon"});let a=e.split(`
`)[0].substring(0,50);n.createSpan({text:a+(e.length>50?"...":""),cls:"claude-thinking-preview"});let o=i.createDiv("claude-thinking-content");o.textContent=e,this.messagesEl.scrollTop=this.messagesEl.scrollHeight}removeThinking(){let e=this.messagesEl.querySelector(".claude-thinking");e&&e.remove()}appendQueuedIndicator(){let e=this.messagesEl.createDiv("claude-queued-indicator");e.createSpan({text:"\u23F3",cls:"claude-queued-icon"}),e.createSpan({text:"Queued - will send when current task completes",cls:"claude-queued-text"}),this.messagesEl.scrollTop=this.messagesEl.scrollHeight}removeQueuedIndicator(){let e=this.messagesEl.querySelector(".claude-queued-indicator");e&&e.remove()}renderMessages(e){this.messagesEl.empty(),e.forEach(s=>this.appendMessage(s))}setLoadingState(e){this.skillSelectEl.disabled=e,e?(this.sendBtn.textContent="Reply",this.sendBtn.removeClass("claude-btn-primary"),this.sendBtn.addClass("claude-btn-secondary"),this.abortBtn.removeClass("claude-hidden"),this.inputEl.placeholder="Type to respond to Claude..."):(this.sendBtn.textContent="Send",this.sendBtn.addClass("claude-btn-primary"),this.sendBtn.removeClass("claude-btn-secondary"),this.abortBtn.addClass("claude-hidden"),this.inputEl.placeholder="Ask Claude anything...")}abortRequest(){this.plugin.cliService.abort(),this.setLoadingState(!1)}showError(e){let s=this.messagesEl.createDiv("claude-error");e.includes("context")||e.includes("token")||e.includes("too long")||e.includes("max_tokens")||e.includes("length_exceeded")?(s.innerHTML=`
        <div class="claude-error-content">
          <strong>Context limit reached</strong>
          <p>The conversation has grown too long. Start a new chat to continue.</p>
        </div>
      `,s.createEl("button",{text:"Start New Chat",cls:"claude-btn claude-btn-secondary claude-btn-small"}).addEventListener("click",()=>{this.startNewSession(),s.remove()})):s.textContent=`Error: ${e}`,this.messagesEl.scrollTop=this.messagesEl.scrollHeight}startNewSession(){let e=this.plugin.sessionManager.createSession();this.currentSessionId=e.id,this.messagesEl.empty(),this.updateMessageCount()}loadSession(e){let s=this.plugin.sessionManager.getSession(e);s&&(this.currentSessionId=e,this.plugin.sessionManager.setActiveSession(e),this.renderMessages(s.messages),this.updateMessageCount())}createContextToggle(e){let s=e.createDiv("claude-context-toggle"),i=s.createEl("button",{cls:`claude-context-btn ${this.includeFileContext?"active":""}`,attr:{"aria-label":"Toggle file context"}}),n=s.createEl("button",{cls:`claude-context-btn ${this.includeWebContext?"active":""}`,attr:{"aria-label":"Toggle web context"}}),a=()=>{let c=this.plugin.app.workspace.getActiveFile();i.empty(),i.createSpan({text:"\u{1F4C4}",cls:"claude-context-icon"}),this.includeFileContext&&c?i.createSpan({text:c.basename,cls:"claude-context-name"}):i.createSpan({text:"No page",cls:"claude-context-name claude-context-off"}),i.toggleClass("active",this.includeFileContext)},o=async()=>{let c=await this.plugin.contextProvider.getWebViewerContext();if(n.empty(),n.createSpan({text:"\u{1F310}",cls:"claude-context-icon"}),this.includeWebContext&&c){let r=c.title&&c.title.length>20?c.title.substring(0,20)+"...":c.title||"Web page";n.createSpan({text:r,cls:"claude-context-name"})}else n.createSpan({text:"No web",cls:"claude-context-name claude-context-off"});n.toggleClass("active",this.includeWebContext)};i.addEventListener("click",()=>{this.includeFileContext=!this.includeFileContext,a()}),n.addEventListener("click",()=>{this.includeWebContext=!this.includeWebContext,o()}),this.registerEvent(this.plugin.app.workspace.on("active-leaf-change",()=>{a(),o()})),a(),o()}setInitialPrompt(e){this.inputEl.value=e,this.inputEl.focus()}generateId(){return`msg-${Date.now()}-${Math.random().toString(36).slice(2,11)}`}async onClose(){this.plugin.cliService.removeAllListeners()}};var V=require("obsidian");function z(g){g.registerMarkdownCodeBlockProcessor("claude-chat",async(t,e,s)=>{await new _(g,t,e,s).render()})}var _=class{constructor(t,e,s,i){this.plugin=t,this.source=e,this.el=s,this.ctx=i,this.state=this.parseSource(e)}parseSource(t){try{if(t.trim()){let e=JSON.parse(t);return{messages:e.messages||[],sessionId:e.sessionId}}}catch(e){if(t.trim())return{messages:[{id:"initial",role:"user",content:t.trim(),timestamp:Date.now()}]}}return{messages:[]}}async render(){this.el.empty(),this.el.addClass("claude-inline-chat"),this.el.createDiv("claude-inline-header").createSpan({text:"Claude Chat",cls:"claude-inline-title"}),this.messagesEl=this.el.createDiv("claude-inline-messages"),this.renderMessages(),this.createInputArea(),this.state.messages.length===1&&this.state.messages[0].role==="user"&&!this.state.sessionId&&await this.sendInitialPrompt()}createInputArea(){let t=this.el.createDiv("claude-inline-input-wrapper");this.inputEl=t.createEl("input",{type:"text",placeholder:"Continue conversation...",cls:"claude-inline-input"}),this.inputEl.addEventListener("keydown",async s=>{s.key==="Enter"&&await this.sendMessage()}),t.createEl("button",{text:"Send",cls:"claude-btn claude-btn-small"}).addEventListener("click",()=>this.sendMessage())}renderMessages(){this.messagesEl.empty();for(let t of this.state.messages){let s=this.messagesEl.createDiv({cls:`claude-inline-message claude-inline-${t.role}`}).createDiv("claude-inline-content");V.MarkdownRenderer.render(this.plugin.app,t.content,s,this.ctx.sourcePath,this.plugin)}}async sendInitialPrompt(){let t=this.state.messages[0].content;await this.executeAndUpdate(t)}async sendMessage(){let t=this.inputEl.value.trim();t&&(this.state.messages.push({id:`msg-${Date.now()}`,role:"user",content:t,timestamp:Date.now()}),this.renderMessages(),this.inputEl.value="",await this.executeAndUpdate(t))}async executeAndUpdate(t){let e=this.messagesEl.createDiv("claude-inline-loading");e.textContent="Claude is thinking...";try{let s=this.ctx.sourcePath,i=this.plugin.app.vault.getAbstractFileByPath(s),n="";if(i){let o=await this.plugin.app.vault.cachedRead(i);n=`Current note (${s}):
${o}

`}let a=await this.plugin.cliService.execute({prompt:n+t,sessionId:this.state.sessionId});a.sessionId&&(this.state.sessionId=a.sessionId),a.finalContent&&this.state.messages.push({id:`msg-${Date.now()}`,role:"assistant",content:a.finalContent,timestamp:Date.now()}),await this.persistState()}catch(s){this.state.messages.push({id:`msg-${Date.now()}`,role:"assistant",content:`Error: ${s.message}`,timestamp:Date.now()})}e.remove(),this.renderMessages()}async persistState(){let t=this.plugin.app.vault.getAbstractFileByPath(this.ctx.sourcePath);if(!t)return;let e=await this.plugin.app.vault.read(t),s=JSON.stringify({sessionId:this.state.sessionId,messages:this.state.messages},null,2),i=/```claude-chat\n[\s\S]*?\n```/,n=e.replace(i,`\`\`\`claude-chat
${s}
\`\`\``);await this.plugin.app.vault.modify(t,n)}};var v=require("obsidian"),G=require("child_process"),U=require("util"),$=(0,U.promisify)(G.exec),I=class extends v.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Claude Code Settings"}),this.renderConnectionStatus(t),t.createEl("h3",{text:"CLI Configuration"}),new v.Setting(t).setName("Claude CLI Path").setDesc('Path to the Claude CLI executable. Leave as "claude" to use PATH, or specify full path.').addText(s=>s.setPlaceholder("claude").setValue(this.plugin.settings.claudePath).onChange(async i=>{this.plugin.settings.claudePath=i||"claude",await this.plugin.saveSettings()})).addButton(s=>s.setButtonText("Auto-detect").onClick(async()=>{let i=await this.detectClaudePath();i?(this.plugin.settings.claudePath=i,await this.plugin.saveSettings(),this.display(),new v.Notice(`Claude CLI found: ${i}`)):new v.Notice("Could not auto-detect Claude CLI. Please install it first.")})),new v.Setting(t).setName("Default Allowed Tools").setDesc("Comma-separated list of tools to auto-approve").addText(s=>s.setPlaceholder("Read,Glob,Grep").setValue(this.plugin.settings.defaultAllowedTools.join(",")).onChange(async i=>{this.plugin.settings.defaultAllowedTools=i.split(",").map(n=>n.trim()).filter(n=>n),await this.plugin.saveSettings()})),new v.Setting(t).setName("Max Turns").setDesc("Maximum agentic turns per request").addSlider(s=>s.setLimits(1,50,1).setValue(this.plugin.settings.maxTurns).setDynamicTooltip().onChange(async i=>{this.plugin.settings.maxTurns=i,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Skills Configuration"}),new v.Setting(t).setName("Skills Folder").setDesc("Path to folder containing custom skills (relative to vault root). Each skill should be a folder with a SKILL.md file.").addText(s=>s.setPlaceholder(".claude/skills").setValue(this.plugin.settings.skillsFolder).onChange(async i=>{this.plugin.settings.skillsFolder=i||".claude/skills",await this.plugin.saveSettings(),await this.plugin.skillLoader.loadSkills()}));let e=t.createDiv("setting-item-description");e.style.marginTop="-10px",e.style.marginBottom="15px",e.innerHTML=`
      <small>
        <strong>Tip:</strong> Use the built-in <code>/skill-creator</code> command to create new skills.
        Skills extend Claude's capabilities with specialized workflows and knowledge.
      </small>
    `,t.createEl("h3",{text:"Context Settings"}),new v.Setting(t).setName("Include Current Note").setDesc("Automatically include the active note as context").addToggle(s=>s.setValue(this.plugin.settings.includeCurrentNote).onChange(async i=>{this.plugin.settings.includeCurrentNote=i,await this.plugin.saveSettings()})),new v.Setting(t).setName("Max Context Files").setDesc("Maximum number of files to include as context").addSlider(s=>s.setLimits(1,50,1).setValue(this.plugin.settings.maxContextFiles).setDynamicTooltip().onChange(async i=>{this.plugin.settings.maxContextFiles=i,await this.plugin.saveSettings()})),new v.Setting(t).setName("Max Context Length").setDesc("Maximum total characters for context").addText(s=>s.setValue(this.plugin.settings.maxContextLength.toString()).onChange(async i=>{let n=parseInt(i);!isNaN(n)&&n>0&&(this.plugin.settings.maxContextLength=n,await this.plugin.saveSettings())})),new v.Setting(t).setName("Excluded Folders").setDesc("Comma-separated list of folders to exclude from context").addText(s=>s.setPlaceholder(".obsidian,.claude-sessions").setValue(this.plugin.settings.excludeFolders.join(",")).onChange(async i=>{this.plugin.settings.excludeFolders=i.split(",").map(n=>n.trim()).filter(n=>n),await this.plugin.saveSettings()})),t.createEl("h3",{text:"UI Preferences"}),new v.Setting(t).setName("Show Tool Calls").setDesc("Display tool usage in the chat interface").addToggle(s=>s.setValue(this.plugin.settings.showToolCalls).onChange(async i=>{this.plugin.settings.showToolCalls=i,await this.plugin.saveSettings()})),new v.Setting(t).setName("Stream Responses").setDesc("Show responses as they stream in").addToggle(s=>s.setValue(this.plugin.settings.streamResponses).onChange(async i=>{this.plugin.settings.streamResponses=i,await this.plugin.saveSettings()})),new v.Setting(t).setName("Default Panel Position").setDesc("Where to open the chat panel").addDropdown(s=>s.addOption("left","Left").addOption("right","Right").setValue(this.plugin.settings.defaultPanelPosition).onChange(async i=>{this.plugin.settings.defaultPanelPosition=i,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Session Management"}),new v.Setting(t).setName("Auto-save Sessions").setDesc("Automatically save conversations").addToggle(s=>s.setValue(this.plugin.settings.autoSaveSessions).onChange(async i=>{this.plugin.settings.autoSaveSessions=i,await this.plugin.saveSettings()})),new v.Setting(t).setName("Session Storage Path").setDesc("Folder path for storing session files").addText(s=>s.setPlaceholder(".claude-sessions").setValue(this.plugin.settings.sessionStoragePath).onChange(async i=>{this.plugin.settings.sessionStoragePath=i||".claude-sessions",await this.plugin.saveSettings()})),new v.Setting(t).setName("Max Session History").setDesc("Number of sessions to retain").addSlider(s=>s.setLimits(10,200,10).setValue(this.plugin.settings.maxSessionHistory).setDynamicTooltip().onChange(async i=>{this.plugin.settings.maxSessionHistory=i,await this.plugin.saveSettings()}))}async renderConnectionStatus(t){let e=t.createDiv("claude-connection-status");e.style.cssText="padding: 15px; margin-bottom: 20px; border-radius: 8px; border: 1px solid var(--background-modifier-border);";let s=e.createDiv();s.innerHTML='<span style="opacity: 0.7;">Checking Claude CLI connection...</span>';let i=await this.checkClaudeConnection();if(e.empty(),i)e.style.borderColor="var(--color-green)",e.style.backgroundColor="rgba(0, 200, 0, 0.1)",e.innerHTML=`
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.5em;">\u2705</span>
          <div>
            <strong>Claude CLI Connected</strong>
            <div style="opacity: 0.8; font-size: 0.9em;">Path: ${this.plugin.settings.claudePath}</div>
          </div>
        </div>
      `;else{e.style.borderColor="var(--color-orange)",e.style.backgroundColor="rgba(255, 165, 0, 0.1)";let n=e.createDiv();n.style.cssText="display: flex; flex-direction: column; gap: 12px;",n.innerHTML=`
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.5em;">\u26A0\uFE0F</span>
          <div>
            <strong>Setup Required</strong>
            <div style="opacity: 0.8; font-size: 0.9em;">Claude Code CLI needs to be installed</div>
          </div>
        </div>
        <div style="background: var(--background-primary); padding: 12px; border-radius: 6px; font-size: 0.9em;">
          <strong>Setup Steps:</strong>
          <ol style="margin: 8px 0 0 0; padding-left: 20px;">
            <li style="margin-bottom: 6px;">Install <a href="https://nodejs.org" style="color: var(--text-accent);">Node.js</a> (if not already installed)</li>
            <li style="margin-bottom: 6px;">Open Terminal and run:<br><code style="background: var(--background-secondary); padding: 2px 6px; border-radius: 3px;">npm install -g @anthropic-ai/claude-code</code></li>
            <li style="margin-bottom: 6px;">Run <code style="background: var(--background-secondary); padding: 2px 6px; border-radius: 3px;">claude</code> to authenticate with your Anthropic account</li>
            <li>Click "Auto-detect" below or restart Obsidian</li>
          </ol>
        </div>
      `;let a=n.createDiv();a.style.cssText="display: flex; gap: 8px; flex-wrap: wrap;";let o=a.createEl("button",{text:"\u{1F4D6} Installation Guide",cls:"mod-cta"});o.style.cssText="font-size: 0.85em;",o.addEventListener("click",()=>{window.open("https://docs.anthropic.com/en/docs/claude-code","_blank")});let c=a.createEl("button",{text:"\u{1F504} Check Again"});c.style.cssText="font-size: 0.85em;",c.addEventListener("click",()=>{this.display()})}}async checkClaudeConnection(){try{let t=this.plugin.settings.claudePath,{stdout:e}=await $(`"${t}" --version`,{timeout:5e3,env:{...process.env,PATH:`/opt/homebrew/bin:/usr/local/bin:${process.env.PATH||""}`}});return e.includes("claude")||e.length>0}catch(t){return!1}}async detectClaudePath(){let t=["claude","/opt/homebrew/bin/claude","/usr/local/bin/claude","/usr/bin/claude",`${process.env.HOME}/.local/bin/claude`,`${process.env.HOME}/.npm-global/bin/claude`];try{let{stdout:e}=await $("which claude",{timeout:3e3}),s=e.trim();s&&!t.includes(s)&&t.unshift(s)}catch(e){}for(let e of t)try{return await $(`"${e}" --version`,{timeout:3e3,env:{...process.env,PATH:`/opt/homebrew/bin:/usr/local/bin:${process.env.PATH||""}`}}),e}catch(s){continue}return null}};var j=require("child_process"),K=require("obsidian");var F=class{constructor(){this.activeToolCalls=new Map}parseLine(t){let e=t.trim();if(!e)return null;try{let s=JSON.parse(e);return console.log("[MessageParser] Raw message:",s.type,s.subtype||""),this.normalizeMessage(s)}catch(s){return null}}normalizeMessage(t){var i,n;let e=[],s={type:t.type,session_id:t.session_id};if(t.type==="assistant"&&((i=t.message)!=null&&i.content)){for(let a of t.message.content)a.type==="thinking"&&a.thinking?e.push({type:"thinking",session_id:t.session_id,content:a.thinking}):a.type==="text"&&a.text?e.push({...s,content:a.text,role:"assistant"}):a.type==="tool_use"&&(a.id&&a.name&&this.activeToolCalls.set(a.id,{name:a.name,input:a.input||{}}),e.push({type:"tool_use",id:a.id,session_id:t.session_id,name:a.name,input:a.input}));return e.length===0&&e.push(s),e}if(t.type==="user"&&((n=t.message)!=null&&n.content)){for(let a of t.message.content)if(a.type==="tool_result"&&a.tool_use_id){let o=this.activeToolCalls.get(a.tool_use_id);e.push({type:"tool_result",id:a.tool_use_id,session_id:t.session_id,name:o==null?void 0:o.name,input:o==null?void 0:o.input,output:a.content,is_error:t.is_error}),this.activeToolCalls.delete(a.tool_use_id)}if(e.length>0)return e}return t.type==="result"&&t.result&&(s.content=t.result),t.type==="system"&&t.subtype==="init"&&(s.subtype="init"),t.type==="tool_use"&&(s.name=t.name||t.tool_name,s.input=t.input),e.push(s),e}reset(){this.activeToolCalls.clear()}};var D=class{constructor(t){this.activeProcess=null;this.listeners=new Map;this.queuedInput=null;this.plugin=t,this.parser=new F}on(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}off(t,e){if(!e)this.listeners.delete(t);else{let s=this.listeners.get(t);if(s){let i=s.indexOf(e);i>-1&&s.splice(i,1)}}}emit(t,e){let s=this.listeners.get(t);s&&s.forEach(i=>i(e))}removeAllListeners(){this.listeners.clear()}async execute(t){let e=this.buildArgs(t),s=[],i,n="";return new Promise((a,o)=>{var m,h,f;let c=this.plugin.settings.claudePath,r="";this.plugin.app.vault.adapter instanceof K.FileSystemAdapter&&(r=this.plugin.app.vault.adapter.getBasePath()),console.log("[Claude Plugin] Spawning:",c,e),this.activeProcess=(0,j.spawn)(c,e,{cwd:r||void 0,env:{...process.env,PATH:`/opt/homebrew/bin:/usr/local/bin:${process.env.PATH||""}`,CI:"true",TERM:"dumb"},stdio:["pipe","pipe","pipe"]}),(m=this.activeProcess.stdin)==null||m.end();let l="",u=setTimeout(()=>{console.log("[Claude Plugin] Process timeout - killing"),this.activeProcess&&this.activeProcess.kill("SIGTERM")},12e4);(h=this.activeProcess.stdout)==null||h.on("data",S=>{l+=S.toString();let p=l.split(`
`);l=p.pop()||"";for(let C of p)if(C.trim())try{let w=this.parser.parseLine(C);if(w)for(let y of w){let X=typeof y.content=="string"?y.content.substring(0,50):"";if(console.log("[Claude Plugin] Parsed message:",y.type,y.name||"",X),s.push(y),y.session_id&&(i=y.session_id),this.emit("message",y),y.type==="assistant"&&y.content){let x=typeof y.content=="string"?y.content:"";n=x,this.emit("partial",x)}if(y.type==="result"&&y.content){let x=typeof y.content=="string"?y.content:"";n=x,this.emit("partial",x)}}}catch(w){console.error("[Claude Plugin] Failed to parse:",w,C)}});let d="";(f=this.activeProcess.stderr)==null||f.on("data",S=>{d+=S.toString(),console.log("[Claude Plugin] stderr:",S.toString())}),this.activeProcess.on("close",S=>{if(clearTimeout(u),console.log("[Claude Plugin] Process closed with code:",S),this.activeProcess=null,l.trim())try{let p=this.parser.parseLine(l);if(p)for(let C of p)s.push(C),C.type==="result"&&C.content&&(n=typeof C.content=="string"?C.content:"",this.emit("partial",n))}catch(p){console.error("[Claude Plugin] Failed to parse final buffer:",p)}a(S===0||n?{success:!0,sessionId:i,messages:s,finalContent:n}:{success:!1,messages:s,error:d||`Process exited with code ${S}`})}),this.activeProcess.on("error",S=>{clearTimeout(u),console.error("[Claude Plugin] Process error:",S),this.activeProcess=null,o(S)})})}buildArgs(t){let e=["-p",t.prompt,"--output-format","stream-json","--verbose"],s=t.allowedTools||this.plugin.settings.defaultAllowedTools;s.length>0&&e.push("--allowedTools",s.join(",")),t.addDirs&&t.addDirs.length>0&&t.addDirs.forEach(n=>{e.push("--add-dir",n)}),t.sessionId&&e.push("--resume",t.sessionId);let i=t.maxTurns||this.plugin.settings.maxTurns;return e.push("--max-turns",i.toString()),t.appendSystemPrompt?e.push("--append-system-prompt",t.appendSystemPrompt):t.systemPrompt&&e.push("--system-prompt",t.systemPrompt),e}abort(){this.activeProcess&&(this.activeProcess.kill("SIGTERM"),this.activeProcess=null)}isRunning(){return this.activeProcess!==null}queueInput(t){return this.isRunning()?(console.log("[Claude Plugin] Queueing input for follow-up:",t.substring(0,50)),this.queuedInput=t,!0):(console.log("[Claude Plugin] Cannot queue input - no active process"),!1)}getAndClearQueuedInput(){let t=this.queuedInput;return this.queuedInput=null,t}hasQueuedInput(){return this.queuedInput!==null}};var P=require("obsidian"),R=class{constructor(t){this.plugin=t}async getCurrentNoteContext(){let t=await this.getWebViewerContext();if(t)return t;let e=this.plugin.app.workspace.getActiveFile();if(!e||e.extension!=="md")return null;let s=await this.plugin.app.vault.cachedRead(e);return{type:"file",path:e.path,title:e.basename,content:s}}async getWebViewerContext(){var t,e,s;try{let i=this.plugin.app.workspace.getLeavesOfType("webviewer");if(i.length===0)return null;let a=(t=i[0].view.contentEl)==null?void 0:t.querySelector("webview");if(!a)return null;if(typeof a.getWebContentsId!="function")return console.log("[Context Provider] WebView not ready yet"),null;let o=((e=a.getURL)==null?void 0:e.call(a))||"",c=((s=a.getTitle)==null?void 0:s.call(a))||o,{remote:r}=require("electron");if(!r)return console.log("[Context Provider] Electron remote API not available"),null;let l=a.getWebContentsId();if(!l)return null;let u=r.webContents.fromId(l);if(!u)return null;let d=await u.executeJavaScript(`
        (function() {
          // Get page title and meta description
          const title = document.title;
          const metaDesc = document.querySelector('meta[name="description"]')?.content || '';

          // Get main text content, excluding scripts and styles
          const clone = document.body.cloneNode(true);
          const scripts = clone.querySelectorAll('script, style, noscript');
          scripts.forEach(el => el.remove());

          const textContent = clone.innerText || clone.textContent || '';

          return {
            title: title,
            description: metaDesc,
            content: textContent.trim()
          };
        })();
      `,!0);if(!d||!d.content)return null;let m=`# ${d.title}

URL: ${o}

${d.description?`${d.description}

`:""}${d.content}`;return{type:"webpage",url:o,title:d.title||c,content:m,path:o}}catch(i){return console.error("[Context Provider] Error extracting web viewer content:",i),null}}async searchVault(t,e){let{vault:s,metadataCache:i}=this.plugin.app,n=s.getMarkdownFiles(),a=[],o=this.extractSearchTerms(t),c=this.plugin.settings.excludeFolders;for(let r of n){if(c.some(p=>r.path.startsWith(p)))continue;let l=0,u,d,m=i.getFileCache(r),h=this.parseFrontmatter(m==null?void 0:m.frontmatter);for(let p of o)r.basename.toLowerCase().includes(p)&&(l+=15,d="filename match");if(h.keywords)for(let p of h.keywords)for(let C of o)p.toLowerCase().includes(C)&&(l+=12,d=d||"keyword match");if(h.tags)for(let p of h.tags)for(let C of o)p.toLowerCase().includes(C)&&(l+=10,d=d||"tag match");if(h.summary)for(let p of o)h.summary.toLowerCase().includes(p)&&(l+=8,d=d||"summary match");if(m!=null&&m.headings)for(let p of m.headings)for(let C of o)p.heading.toLowerCase().includes(C)&&(l+=6,d=d||"heading match");let f=await s.cachedRead(r),S=f.toLowerCase();for(let p of o){let C=S.indexOf(p);if(C!==-1){if(l+=4,!u){let w=Math.max(0,C-50),y=Math.min(f.length,C+p.length+100);u=f.substring(w,y)}d=d||"content match"}}(h.status==="active"||h.status==="wip")&&(l+=3),l>0&&a.push({file:r,path:r.path,title:h.title||r.basename,excerpt:u,score:l,relevanceReason:d})}return a.sort((r,l)=>l.score-r.score).slice(0,e||this.plugin.settings.maxContextFiles)}async getRelatedFiles(t,e=1){let{vault:s,metadataCache:i}=this.plugin.app,n=new Set,a=new Set;await(async(r,l)=>{if(l>e||a.has(r.path))return;a.add(r.path);let u=i.getFileCache(r);if(u!=null&&u.links)for(let h of u.links){let f=i.getFirstLinkpathDest(h.link,r.path);f&&f instanceof P.TFile&&n.add(f.path)}let d=this.parseFrontmatter(u==null?void 0:u.frontmatter);if(d.related)for(let h of d.related){let f=h.match(/\[\[([^\]]+)\]\]/),S=f?f[1]:h,p=i.getFirstLinkpathDest(S,r.path);p&&p instanceof P.TFile&&n.add(p.path)}let m=s.getMarkdownFiles();for(let h of m){if(h.path===r.path)continue;let f=i.getFileCache(h);if(f!=null&&f.links)for(let S of f.links){let p=i.getFirstLinkpathDest(S.link,h.path);if(p&&p.path===r.path){n.add(h.path);break}}}})(t,0);let c=[];for(let r of n)if(r!==t.path){let l=s.getAbstractFileByPath(r);l instanceof P.TFile&&c.push(l)}return c}parseFrontmatter(t){return t?{title:t.title,tags:this.normalizeArray(t.tags),keywords:this.normalizeArray(t.keywords),related:this.normalizeArray(t.related),summary:t.summary,type:t.type,status:t.status}:{}}normalizeArray(t){if(t){if(Array.isArray(t))return t.map(String);if(typeof t=="string")return t.split(",").map(e=>e.trim())}}extractSearchTerms(t){let e=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","as","is","was","are","were","been","be","have","has","had","do","does","did","will","would","could","should","may","might","must","can","this","that","these","those","i","you","he","she","it","we","they","what","which","who","when","where","why","how","all","each","every","both","few","more","most","other","some","such","no","not","only","own","same","so","than","too","very","just","about","into","through","during","before","after","above","below","between","under","again","further","then","once","here","there","any","me","my","help","find","show","get","tell","give","please","want","need","look","see"]);return t.toLowerCase().replace(/[^\w\s-]/g," ").split(/\s+/).filter(s=>s.length>2&&!e.has(s))}metadataMatchesQuery(t,e){var s,i;return!!((s=t.tags)!=null&&s.some(n=>n.tag.toLowerCase().includes(e))||(i=t.headings)!=null&&i.some(n=>n.heading.toLowerCase().includes(e)))}async gatherContext(t,e){let s=[],i=new Set,n=0,a=this.plugin.settings.maxContextLength,o=async(r,l)=>{if(i.has(r.path))return!1;let u=await this.plugin.app.vault.cachedRead(r);if(n+u.length>=a)return!1;let d=this.plugin.app.metadataCache.getFileCache(r),m=this.parseFrontmatter(d==null?void 0:d.frontmatter);return s.push({type:"file",path:r.path,title:m.title||r.basename,content:u}),i.add(r.path),n+=u.length,!0};if(this.plugin.settings.includeCurrentNote){let r=this.plugin.app.workspace.getActiveFile();if(r&&r.extension==="md"){await o(r,"active file");let l=await this.getRelatedFiles(r,1);for(let u of l.slice(0,3)){if(n>=a*.5)break;await o(u,"related via wikilink")}}}if(e)for(let r of e)await o(r,"explicitly provided");let c=await this.searchVault(t);for(let r of c)if(!await o(r.file,r.relevanceReason))break;return{files:s,totalLength:n,truncated:n>=a}}formatContextForPrompt(t){return t.length===0?"":`Here is relevant context from the vault:

${t.map(s=>`--- File: ${s.path} ---
${s.content}
--- End File ---`).join(`

`)}

`}async getVaultAwareness(t=!0){let{vault:e}=this.plugin.app,s=e.adapter.basePath||e.getName(),n=e.getRoot().children.filter(c=>!(c instanceof P.TFile)).map(c=>c.name).filter(c=>!c.startsWith(".")).sort(),a=e.getMarkdownFiles().length,o=`You are working in an Obsidian vault located at: ${s}

This vault contains ${a} markdown files organized in these folders:
${n.map(c=>`- ${c}/`).join(`
`)}

To explore the vault, use your tools:
- Use Glob to find files by pattern (e.g., "**/*.md", "Meeting Notes/**/*.md")
- Use Grep to search file contents
- Use Read to read specific files

Do NOT ask me to provide file contents - use your tools to read them directly.`;if(t){let c=this.plugin.app.workspace.getActiveFile();if(c&&c.extension==="md"){let r=this.plugin.app.metadataCache.getFileCache(c),l=this.parseFrontmatter(r==null?void 0:r.frontmatter);o+=`

The user currently has this file open: ${c.path}`,l.title&&(o+=`
  Title: ${l.title}`),l.tags&&l.tags.length>0&&(o+=`
  Tags: ${l.tags.join(", ")}`),l.summary&&(o+=`
  Summary: ${l.summary}`),o+=`
If the user's question seems related to this file, read it with the Read tool.`}}return o+`

`}getCurrentFileReference(){let t=this.plugin.app.workspace.getActiveFile();if(!t||t.extension!=="md")return null;let e=this.plugin.app.metadataCache.getFileCache(t),s=this.parseFrontmatter(e==null?void 0:e.frontmatter);return{path:t.path,title:s.title||t.basename}}};var Q=require("obsidian"),A=class{constructor(t){this.sessions=new Map;this.activeSessionId=null;this.plugin=t}async initialize(){await this.ensureStorageFolder(),await this.loadSessions()}async ensureStorageFolder(){let{vault:t}=this.plugin.app,e=this.plugin.settings.sessionStoragePath;await t.adapter.exists(e)||await t.createFolder(e)}async loadSessions(){let{vault:t}=this.plugin.app,e=this.plugin.settings.sessionStoragePath;try{if(!await t.adapter.exists(e)){console.log("[SessionManager] Session folder does not exist yet");return}let i=await t.adapter.list(e);for(let n of i.files)if(n.endsWith(".json"))try{let a=await t.adapter.read(n),o=JSON.parse(a);this.sessions.set(o.id,o),console.log("[SessionManager] Loaded session:",o.id)}catch(a){console.error("[SessionManager] Failed to parse session file:",n,a)}console.log("[SessionManager] Loaded",this.sessions.size,"sessions")}catch(s){console.error("[SessionManager] Failed to load sessions:",s)}}createSession(t){let e=this.generateId(),s={id:e,name:t||`Chat ${new Date().toLocaleDateString()}`,messages:[],context:[],createdAt:Date.now(),updatedAt:Date.now()};return this.sessions.set(e,s),this.activeSessionId=e,s}getSession(t){return this.sessions.get(t)}getActiveSession(){return this.activeSessionId&&this.sessions.get(this.activeSessionId)||null}setActiveSession(t){this.activeSessionId=t}addMessage(t,e){let s=this.sessions.get(t);s&&(s.messages.push(e),s.updatedAt=Date.now(),this.plugin.settings.autoSaveSessions&&this.saveSession(s))}updateLastMessage(t,e){let s=this.sessions.get(t);if(s&&s.messages.length>0){let i=s.messages[s.messages.length-1];i.content=e,i.isStreaming=!0}}finalizeLastMessage(t){let e=this.sessions.get(t);if(e&&e.messages.length>0){let s=e.messages[e.messages.length-1];s.isStreaming=!1,e.updatedAt=Date.now(),this.plugin.settings.autoSaveSessions&&this.saveSession(e)}}async saveSession(t){let{vault:e}=this.plugin.app,s=`${this.plugin.settings.sessionStoragePath}/${t.id}.json`,i=JSON.stringify(t,null,2);try{await e.adapter.exists(s)?await e.adapter.write(s,i):await e.create(s,i)}catch(n){console.error("Failed to save session:",n)}}async saveAllSessions(){for(let t of this.sessions.values())await this.saveSession(t)}getAllSessions(){return Array.from(this.sessions.values()).sort((t,e)=>e.updatedAt-t.updatedAt)}async deleteSession(t){let{vault:e}=this.plugin.app,s=`${this.plugin.settings.sessionStoragePath}/${t}.json`;this.sessions.delete(t);try{let i=e.getAbstractFileByPath(s);i instanceof Q.TFile&&await e.delete(i)}catch(i){console.error("Failed to delete session file:",i)}}setClaudeSessionId(t,e){let s=this.sessions.get(t);s&&(s.claudeSessionId=e)}generateId(){return`session-${Date.now()}-${Math.random().toString(36).slice(2,11)}`}};var J=require("obsidian"),k=W(require("fs")),T=W(require("path")),re={id:"skill-creator",name:"Skill Creator",description:"Guide for creating effective skills. Use when you want to create a new skill (or update an existing skill) that extends Claude's capabilities with specialized knowledge, workflows, or tool integrations.",icon:"\u{1F6E0}\uFE0F",isBuiltIn:!0},le=`---
name: skill-creator
description: Guide for creating effective skills. This skill should be used when users want to create a new skill (or update an existing skill) that extends Claude's capabilities with specialized knowledge, workflows, or tool integrations.
---

# Skill Creator

This skill provides guidance for creating effective skills for this Obsidian vault.

## About Skills

Skills are modular, self-contained packages that extend Claude's capabilities by providing specialized knowledge, workflows, and tools. Think of them as "onboarding guides" for specific domains or tasks\u2014they transform Claude from a general-purpose agent into a specialized agent equipped with procedural knowledge.

### What Skills Provide

1. **Specialized workflows** - Multi-step procedures for specific domains
2. **Tool integrations** - Instructions for working with specific file formats or APIs
3. **Domain expertise** - Company-specific knowledge, schemas, business logic
4. **Bundled resources** - Scripts, references, and assets for complex and repetitive tasks

## Skill Structure

Every skill consists of a required SKILL.md file and optional bundled resources:

\`\`\`
skill-name/
\u251C\u2500\u2500 SKILL.md (required)
\u2502   \u251C\u2500\u2500 YAML frontmatter metadata (required)
\u2502   \u2502   \u251C\u2500\u2500 name: (required)
\u2502   \u2502   \u2514\u2500\u2500 description: (required)
\u2502   \u2514\u2500\u2500 Markdown instructions (required)
\u2514\u2500\u2500 Bundled Resources (optional)
    \u251C\u2500\u2500 scripts/          - Executable code (Python/Bash/etc.)
    \u251C\u2500\u2500 references/       - Documentation intended to be loaded into context as needed
    \u2514\u2500\u2500 assets/           - Files used in output (templates, icons, fonts, etc.)
\`\`\`

### SKILL.md Requirements

Every SKILL.md must have:

- **Frontmatter** (YAML): Contains \`name\` and \`description\` fields
  - \`name\`: The skill identifier (hyphen-case, e.g., "my-skill")
  - \`description\`: Clear explanation of what the skill does AND when to use it
- **Body** (Markdown): Instructions and guidance for using the skill

### Bundled Resources

#### scripts/
Executable code (Python/Bash/etc.) for tasks requiring deterministic reliability.
- Include when the same code is being rewritten repeatedly
- Scripts can be executed without loading into context

#### references/
Documentation loaded into context as needed.
- Database schemas, API documentation, domain knowledge
- Keep files under 100 lines when possible, include TOC for longer files

#### assets/
Files used in output (not loaded into context).
- Templates, images, icons, boilerplate code, fonts

## Creating a New Skill

### Step 1: Plan the Skill

Before creating, determine:
1. What specific tasks should this skill handle?
2. What resources (scripts, references, assets) would be helpful?
3. When should Claude automatically recognize to use this skill?

### Step 2: Create the Skill Directory

Create a new folder in the skills directory with this structure:

\`\`\`bash
# In your vault's skills folder (default: .claude/skills/)
mkdir -p my-new-skill
\`\`\`

### Step 3: Create SKILL.md

Create the SKILL.md file with required frontmatter:

\`\`\`yaml
---
name: my-new-skill
description: [Clear description of what the skill does]. Use when [specific scenarios that trigger this skill].
---

# My New Skill

## Overview
[1-2 sentences explaining what this skill enables]

## Usage
[Instructions for how to use the skill]

## [Additional sections as needed]
\`\`\`

### Step 4: Add Resources (Optional)

Add any supporting resources:
- \`scripts/\` - Python/Bash scripts for automation
- \`references/\` - Documentation and guides
- \`assets/\` - Templates and files for output

### Step 5: Test the Skill

After creating the skill:
1. Reload the plugin settings or restart Obsidian
2. The skill should appear in the Mode dropdown
3. Test with relevant prompts to ensure it triggers correctly

## Best Practices

### Writing Good Descriptions

The description is critical - it determines when Claude uses the skill:

**Good:** "Process meeting notes to extract action items, decisions, and key discussion points. Use when reviewing meeting transcripts, summarizing discussions, or creating follow-up task lists."

**Bad:** "Meeting notes skill"

### Keep SKILL.md Concise

- Claude is already very smart - only add context it doesn't have
- Challenge each piece of information: "Does this justify its token cost?"
- Prefer concise examples over verbose explanations
- Target under 500 lines; split into references if longer

### Set Appropriate Degrees of Freedom

- **High freedom**: Text instructions for contextual decisions
- **Medium freedom**: Pseudocode or scripts with parameters
- **Low freedom**: Specific scripts for fragile operations

## Example Skills

### Simple Task Skill
\`\`\`yaml
---
name: code-review
description: Review code for quality, security, and best practices. Use when asked to review PRs, audit code, or suggest improvements.
---

# Code Review

## Review Checklist
1. Security vulnerabilities (OWASP top 10)
2. Performance issues
3. Code style and readability
4. Test coverage
5. Documentation

## Output Format
Provide findings as:
- \u{1F534} Critical issues (must fix)
- \u{1F7E1} Suggestions (should consider)
- \u{1F7E2} Good practices (already doing well)
\`\`\`

### Skill with Scripts
\`\`\`yaml
---
name: data-processor
description: Process and transform data files. Use for CSV manipulation, JSON transformation, or data cleaning tasks.
---

# Data Processor

## Available Scripts

- \`scripts/csv_cleaner.py\` - Remove duplicates and empty rows
- \`scripts/json_transformer.py\` - Transform JSON structure

## Usage
Specify the input file and desired transformation.
\`\`\`
`,ce={"skill-creator":"\u{1F6E0}\uFE0F",tasks:"\u2705",meeting:"\u{1F4DD}",prfaq:"\u{1F4C4}",blog:"\u270D\uFE0F",research:"\u{1F50D}",oneone:"\u{1F464}",project:"\u{1F4CA}",perf:"\u{1F3C6}",audit:"\u{1F5C2}\uFE0F",jira:"\u{1F3AB}",feedback:"\u{1F4AC}",metrics:"\u{1F4C8}",confluence:"\u{1F504}",fullstory:"\u{1F3AC}",changelog:"\u{1F4CB}",competitive:"\u{1F3C1}",scrape:"\u{1F577}\uFE0F"},B=class{constructor(t){this.skills=[];this.plugin=t}async loadSkills(){try{this.skills=[{id:"",name:"General",description:"General assistant",icon:"\u{1F4AC}"}],this.skills.push(re);let t=await this.loadSkillsFromFolder();return t.sort((e,s)=>e.name.localeCompare(s.name)),this.skills.push(...t),console.log("[Skill Loader] Loaded",this.skills.length-1,"skills (1 built-in +",t.length,"from folder)"),this.skills}catch(t){return console.error("[Skill Loader] Error loading skills:",t),this.skills}}async loadSkillsFromFolder(){let t=[];try{let e="";if(this.plugin.app.vault.adapter instanceof J.FileSystemAdapter&&(e=this.plugin.app.vault.adapter.getBasePath()),!e)return console.log("[Skill Loader] Could not determine vault path"),t;let s=this.plugin.settings.skillsFolder,i=T.join(e,s);if(console.log("[Skill Loader] Looking for skills in:",i),!k.existsSync(i))return console.log("[Skill Loader] Skills folder does not exist:",i),t;let n=k.readdirSync(i,{withFileTypes:!0});for(let a of n){if(!a.isDirectory()||a.name==="skill-creator")continue;let o=T.join(i,a.name),c=T.join(o,"SKILL.md");if(!k.existsSync(c)){console.log("[Skill Loader] No SKILL.md found in:",o);continue}try{let r=k.readFileSync(c,"utf-8"),l=this.parseSkillMd(r,a.name);l&&(l.skillPath=o,t.push(l),console.log("[Skill Loader] Loaded skill:",l.id))}catch(r){console.error("[Skill Loader] Error parsing skill:",a.name,r)}}}catch(e){console.error("[Skill Loader] Error reading skills folder:",e)}return t}parseSkillMd(t,e){let s=e,i="",n=t.match(/^---\n([\s\S]*?)\n---/);if(n){let o=n[1],c=o.match(/^name:\s*(.+)$/m);c&&(s=c[1].trim());let r=o.match(/^description:\s*(.+)$/m);r&&(i=r[1].trim())}if(!i){let o=t.split(`
`).filter(r=>r.trim()),c=0;if(n){let r=t.indexOf("---",4);if(r>0){let l=t.slice(r+3).trim(),u=l.split(`
`).filter(m=>m.trim()),d=l.match(/^#\s+(.+)$/m);for(let m of u)if(!m.startsWith("#")&&m.trim().length>10){i=m.trim().substring(0,200);break}}}else{for(let l of o)if(!l.startsWith("#")&&l.trim().length>10){i=l.trim().substring(0,200);break}let r=t.match(/^#\s+(.+)$/m)}}i||(i=`${this.formatSkillName(s)} skill`,console.log("[Skill Loader] Using fallback description for:",s));let a=ce[s]||"\u26A1";return console.log("[Skill Loader] Parsed skill:",s,"-",i.substring(0,50)),{id:s,name:this.formatSkillName(s),description:i,icon:a}}formatSkillName(t){let e={"skill-creator":"Skill Creator",tasks:"Task Management",meeting:"Meeting Notes",prfaq:"PRFAQ",blog:"Blog/Content",research:"Research",oneone:"1:1 & Performance",project:"Project Tracker",perf:"Performance",audit:"Vault Audit",jira:"Jira Tickets",feedback:"Feedback",metrics:"Metrics",confluence:"Confluence",fullstory:"FullStory",changelog:"Changelog",competitive:"Competitive Intel",scrape:"Site Scraper"};return e[t]?e[t]:t.split("-").map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" ")}getSkills(){return this.skills}async getSkillContent(t){if(t==="skill-creator")return le;let e=this.skills.find(s=>s.id===t);if(!e||!e.skillPath)return null;try{let s=T.join(e.skillPath,"SKILL.md");if(k.existsSync(s))return k.readFileSync(s,"utf-8")}catch(s){console.error("[Skill Loader] Error reading skill content:",t,s)}return null}getSkillPath(t){let e=this.skills.find(s=>s.id===t);return(e==null?void 0:e.skillPath)||null}};var H=class extends Y.Plugin{async onload(){await this.loadSettings(),this.cliService=new D(this),this.contextProvider=new R(this),this.sessionManager=new A(this),this.skillLoader=new B(this),await this.sessionManager.initialize(),await this.skillLoader.loadSkills(),this.registerView(E,t=>new L(t,this)),z(this),this.addRibbonIcon("message-circle","Open Claude Chat",()=>{this.activateChatPanel()}),this.addCommand({id:"open-claude-chat",name:"Open Claude Chat Panel",callback:()=>this.activateChatPanel()}),this.addCommand({id:"ask-claude-about-selection",name:"Ask Claude about selection",editorCallback:t=>{let e=t.getSelection();e&&this.activateChatPanel(e)}}),this.addCommand({id:"confluence-push",name:"Confluence: Push to Confluence",callback:()=>{this.activateChatPanel("/confluence push")}}),this.addCommand({id:"confluence-pull",name:"Confluence: Pull from Confluence",callback:()=>{this.activateChatPanel("/confluence pull")}}),this.addCommand({id:"confluence-status",name:"Confluence: Check sync status",callback:()=>{this.activateChatPanel("/confluence status")}}),this.addCommand({id:"confluence-list",name:"Confluence: List all synced files",callback:()=>{this.activateChatPanel("/confluence list")}}),this.addSettingTab(new I(this.app,this)),this.app.workspace.onLayoutReady(()=>{this.activateChatPanel()})}async onunload(){await this.sessionManager.saveAllSessions()}async loadSettings(){this.settings=Object.assign({},O,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async activateChatPanel(t){let{workspace:e}=this.app,s=e.getLeavesOfType(E)[0];s||(s=this.settings.defaultPanelPosition==="left"?e.getLeftLeaf(!1):e.getRightLeaf(!1),await s.setViewState({type:E,active:!0})),e.revealLeaf(s),t&&s.view.setInitialPrompt(t)}};
