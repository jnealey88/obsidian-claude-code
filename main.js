var ee=Object.create;var D=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var se=Object.getOwnPropertyNames;var ne=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty;var ae=(d,t)=>{for(var e in t)D(d,e,{get:t[e],enumerable:!0})},O=(d,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of se(t))!ie.call(d,n)&&n!==e&&D(d,n,{get:()=>t[n],enumerable:!(s=te(t,n))||s.enumerable});return d};var q=(d,t,e)=>(e=d!=null?ee(ne(d)):{},O(t||!d||!d.__esModule?D(e,"default",{value:d,enumerable:!0}):e,d)),oe=d=>O(D({},"__esModule",{value:!0}),d);var me={};ae(me,{default:()=>H});module.exports=oe(me);var Z=require("obsidian");var V={claudePath:"claude",defaultAllowedTools:["Read","Glob","Grep","Edit","Write","Bash","WebFetch","WebSearch","Task","AskUserQuestion"],maxTurns:25,skillsFolder:".claude/skills",includeCurrentNote:!0,maxContextFiles:10,maxContextLength:5e4,excludeFolders:[".obsidian",".claude-sessions","node_modules"],showToolCalls:!0,streamResponses:!0,defaultPanelPosition:"right",autoSaveSessions:!0,sessionStoragePath:".claude-sessions",maxSessionHistory:50};var re={Read:{name:"Read",category:"read",icon:"\u{1F4D6}",color:"#4CAF50",description:"Reading file"},Edit:{name:"Edit",category:"write",icon:"\u270F\uFE0F",color:"#FF9800",description:"Editing file"},Write:{name:"Write",category:"write",icon:"\u{1F4DD}",color:"#FF9800",description:"Writing file"},Glob:{name:"Glob",category:"search",icon:"\u{1F50D}",color:"#2196F3",description:"Finding files"},Grep:{name:"Grep",category:"search",icon:"\u{1F50E}",color:"#2196F3",description:"Searching content"},Bash:{name:"Bash",category:"execute",icon:"\u{1F4BB}",color:"#9C27B0",description:"Running command"},WebFetch:{name:"WebFetch",category:"web",icon:"\u{1F310}",color:"#00BCD4",description:"Fetching URL"},WebSearch:{name:"WebSearch",category:"web",icon:"\u{1F50D}",color:"#00BCD4",description:"Searching web"},Task:{name:"Task",category:"agent",icon:"\u{1F916}",color:"#E91E63",description:"Running agent"},TodoWrite:{name:"TodoWrite",category:"write",icon:"\u2705",color:"#8BC34A",description:"Managing todos"},AskUserQuestion:{name:"AskUserQuestion",category:"agent",icon:"\u2753",color:"#FFC107",description:"Asking question"}};function U(d){return re[d]||{name:d,category:"execute",icon:"\u2699\uFE0F",color:"#757575",description:"Running tool"}}var k=require("obsidian");var P="claude-chat-panel",I=class extends k.ItemView{constructor(e,s){super(e);this.currentSessionId=null;this.selectedSkill="";this.currentResponseEl=null;this.accumulatedContent="";this.showingHistory=!1;this.includeFileContext=!0;this.includeWebContext=!0;this.activeToolCalls=new Map;this.plugin=s}getViewType(){return P}getDisplayText(){return"Claude chat"}getIcon(){return"message-circle"}async onOpen(){let e=this.contentEl;e.empty(),e.addClass("claude-chat-container"),this.createHeader(e),this.historyPanelEl=e.createDiv("claude-history-panel claude-hidden"),this.mainContentEl=e.createDiv("claude-main-content"),this.createSkillBar(this.mainContentEl),this.messagesEl=this.mainContentEl.createDiv("claude-messages"),this.createInputArea(this.mainContentEl),this.setupEventListeners(),this.initializeSession()}createHeader(e){let s=e.createDiv("claude-chat-header"),n=s.createDiv("claude-header-left"),i=n.createEl("button",{cls:"claude-btn claude-btn-icon",attr:{"aria-label":"Chat history"}});(0,k.setIcon)(i,"menu"),i.addEventListener("click",()=>this.toggleHistory()),n.createEl("span",{text:"Claude chat",cls:"claude-header-title"}),this.msgCountEl=n.createEl("span",{cls:"claude-msg-count"}),s.createDiv("claude-header-controls").createEl("button",{text:"+ New",cls:"claude-btn claude-btn-secondary claude-btn-small"}).addEventListener("click",()=>this.startNewSession())}updateMessageCount(){let e=this.plugin.sessionManager.getSession(this.currentSessionId);if(e&&this.msgCountEl){let s=e.messages.length,n=s>20,i=s>40;this.msgCountEl.textContent=`${s} msgs`,this.msgCountEl.toggleClass("warning",n&&!i),this.msgCountEl.toggleClass("danger",i),this.msgCountEl.title=i?"Conversation is very long - consider starting a new chat":n?"Conversation is getting long":""}}toggleHistory(){this.showingHistory=!this.showingHistory,this.showingHistory?(this.historyPanelEl.removeClass("claude-hidden"),this.mainContentEl.addClass("claude-hidden"),this.renderHistoryPanel()):(this.historyPanelEl.addClass("claude-hidden"),this.mainContentEl.removeClass("claude-hidden"))}renderHistoryPanel(){this.historyPanelEl.empty(),this.historyPanelEl.createDiv("claude-history-header").createEl("span",{text:"Chat history",cls:"claude-history-title"});let s=this.historyPanelEl.createDiv("claude-history-list"),n=this.plugin.sessionManager.getAllSessions();if(n.length===0){s.createDiv({text:"No previous chats.",cls:"claude-history-empty"});return}n.sort((i,a)=>a.createdAt-i.createdAt),n.forEach(i=>{var f;let a=s.createDiv({cls:`claude-history-item ${i.id===this.currentSessionId?"active":""}`}),o=a.createDiv("claude-history-info"),l=i.messages.find(h=>h.role==="user"),r=((f=l==null?void 0:l.content)==null?void 0:f.substring(0,50))||"New chat";o.createDiv({text:r+(r.length>=50?"...":""),cls:"claude-history-preview"});let p=new Date(i.createdAt).toLocaleDateString(void 0,{month:"short",day:"numeric"});o.createDiv({text:`${p} \xB7 ${i.messages.length} msgs`,cls:"claude-history-meta"}),a.addEventListener("click",()=>{this.loadSession(i.id),this.toggleHistory()});let u=a.createEl("button",{cls:"claude-history-delete",attr:{"aria-label":"Delete chat"}});(0,k.setIcon)(u,"x"),u.addEventListener("click",h=>{h.stopPropagation(),this.deleteSession(i.id)})})}async deleteSession(e){await this.plugin.sessionManager.deleteSession(e),e===this.currentSessionId&&this.startNewSession(),this.renderHistoryPanel()}createSkillBar(e){let s=e.createDiv("claude-skill-bar"),n=s.createSpan({cls:"claude-skill-label"});n.textContent="Mode:",this.skillSelectEl=s.createEl("select",{cls:"claude-skill-select"}),this.plugin.skillLoader.getSkills().forEach(o=>{let l=this.skillSelectEl.createEl("option",{text:`${o.icon} ${o.name}`,value:o.id});l.title=o.description}),this.skillSelectEl.addEventListener("change",()=>{this.selectedSkill=this.skillSelectEl.value,this.updateSkillHint()});let a=s.createDiv("claude-skill-hint");a.id="skill-hint",this.updateSkillHint()}updateSkillHint(){let e=this.contentEl.querySelector("#skill-hint");if(e){let n=this.plugin.skillLoader.getSkills().find(i=>i.id===this.selectedSkill);e.textContent=(n==null?void 0:n.description)||""}}createInputArea(e){let s=e.createDiv("claude-input-wrapper"),n=s.createDiv("claude-context-bar");this.createContextToggle(n),this.inputEl=s.createEl("textarea",{placeholder:"Ask Claude anything...",cls:"claude-input"}),this.inputEl.addEventListener("keydown",a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),this.sendMessage())});let i=s.createDiv("claude-btn-container");this.sendBtn=i.createEl("button",{text:"Send",cls:"claude-btn claude-btn-primary"}),this.sendBtn.addEventListener("click",()=>this.sendMessage()),this.abortBtn=i.createEl("button",{text:"Stop",cls:"claude-btn claude-btn-danger claude-hidden"}),this.abortBtn.addEventListener("click",()=>this.abortRequest())}setupEventListeners(){this.plugin.cliService.on("message",e=>{this.handleStreamMessage(e)}),this.plugin.cliService.on("partial",e=>{this.updateStreamingMessage(e)})}initializeSession(){let e=this.plugin.sessionManager.getActiveSession();if(!e){let s=this.plugin.sessionManager.getAllSessions();s.length>0?(e=s[0],this.plugin.sessionManager.setActiveSession(e.id)):e=this.plugin.sessionManager.createSession()}this.currentSessionId=e.id,this.renderMessages(e.messages),this.updateMessageCount()}async sendMessage(){var a;let e=this.inputEl.value.trim();if(!e)return;if(this.plugin.cliService.isRunning()){if(this.plugin.cliService.queueInput(e)){let l={id:this.generateId(),role:"user",content:e,timestamp:Date.now()};this.plugin.sessionManager.addMessage(this.currentSessionId,l),this.appendMessage(l),this.inputEl.value="",this.updateMessageCount(),this.appendQueuedIndicator()}return}let s=e,n;if(this.selectedSkill){let o=await this.plugin.skillLoader.getSkillContent(this.selectedSkill);o&&(n=o),s=`/${this.selectedSkill} ${e}`}let i={id:this.generateId(),role:"user",content:e,timestamp:Date.now()};this.plugin.sessionManager.addMessage(this.currentSessionId,i),this.appendMessage(i),this.inputEl.value="",this.setLoadingState(!0),this.currentResponseEl=null,this.accumulatedContent="",this.appendThinking();try{let o="";if(this.includeFileContext&&(o=await this.plugin.contextProvider.getVaultAwareness(!0)),this.includeWebContext){let c=await this.plugin.contextProvider.getWebViewerContext();c&&(o+=`

--- Web Page Context ---
${c.content}
--- End Web Page ---

`)}let l=this.plugin.sessionManager.getSession(this.currentSessionId);console.debug("[Claude Plugin] Executing with lightweight context, file awareness:",this.includeFileContext,"web context:",this.includeWebContext,"skill:",this.selectedSkill||"none");let r=await this.plugin.cliService.execute({prompt:o+s,sessionId:l==null?void 0:l.claudeSessionId,appendSystemPrompt:n});if(console.debug("[Claude Plugin] Execution result:",r.success,(a=r.finalContent)==null?void 0:a.substring(0,50)),r.sessionId&&this.plugin.sessionManager.setClaudeSessionId(this.currentSessionId,r.sessionId),this.accumulatedContent){let c={id:this.generateId(),role:"assistant",content:this.accumulatedContent,timestamp:Date.now()};this.plugin.sessionManager.addMessage(this.currentSessionId,c)}this.finalizeStreamingMessage(),this.updateMessageCount()}catch(o){this.showError(o.message)}finally{this.setLoadingState(!1);let o=this.plugin.cliService.getAndClearQueuedInput();o&&(this.removeQueuedIndicator(),setTimeout(()=>{this.inputEl.value=o,this.sendMessage()},100))}}handleStreamMessage(e){if(e.type==="thinking"&&e.content){this.removeThinking();let s=typeof e.content=="string"?e.content:"";this.appendThinkingContent(s),this.finalizeCurrentResponse()}if(e.type==="assistant"&&e.content){this.removeThinking();let s=typeof e.content=="string"?e.content:"";this.currentResponseEl||this.createResponseElement(),this.accumulatedContent=s}e.type==="tool_use"&&this.plugin.settings.showToolCalls&&(this.removeThinking(),this.finalizeCurrentResponse(),this.appendToolCall(e.name||"unknown",e.input||{},e.id),this.appendThinking()),e.type==="tool_result"&&this.handleToolResult(e),e.type==="result"&&(this.removeThinking(),this.activeToolCalls.clear())}createResponseElement(){this.currentResponseEl=this.messagesEl.createDiv({cls:"claude-message claude-message-assistant streaming"}),this.currentResponseEl.createDiv("claude-message-content");let e=this.currentResponseEl.createEl("button",{cls:"claude-copy-btn",attr:{"aria-label":"Copy to clipboard"}});(0,k.setIcon)(e,"copy"),e.addEventListener("click",()=>{navigator.clipboard.writeText(this.accumulatedContent).then(()=>{(0,k.setIcon)(e,"check"),setTimeout(()=>{(0,k.setIcon)(e,"copy")},2e3)})}),this.messagesEl.scrollTop=this.messagesEl.scrollHeight}finalizeCurrentResponse(){this.currentResponseEl&&(this.currentResponseEl.removeClass("streaming"),this.currentResponseEl=null)}updateStreamingMessage(e){var n;this.currentResponseEl||(this.removeThinking(),this.createResponseElement());let s=(n=this.currentResponseEl)==null?void 0:n.querySelector(".claude-message-content");s&&(s.empty(),k.MarkdownRenderer.render(this.plugin.app,e,s,"",this.plugin),this.accumulatedContent=e,this.messagesEl.scrollTop=this.messagesEl.scrollHeight)}finalizeStreamingMessage(){this.finalizeCurrentResponse();let e=this.messagesEl.querySelector(".claude-message.streaming");e&&e.removeClass("streaming")}appendMessage(e){let s=this.messagesEl.createDiv({cls:`claude-message claude-message-${e.role} ${e.isStreaming?"streaming":""}`}),n=s.createDiv("claude-message-content");if(e.content&&k.MarkdownRenderer.render(this.plugin.app,e.content,n,"",this.plugin),e.role==="assistant"){let i=s.createEl("button",{cls:"claude-copy-btn",attr:{"aria-label":"Copy to clipboard"}});(0,k.setIcon)(i,"copy"),i.addEventListener("click",()=>{let a=e.content||"";navigator.clipboard.writeText(a).then(()=>{(0,k.setIcon)(i,"check"),setTimeout(()=>{(0,k.setIcon)(i,"copy")},2e3)})})}this.messagesEl.scrollTop=this.messagesEl.scrollHeight}appendToolCall(e,s,n){let i=U(e),a=this.messagesEl.createDiv("claude-tool-call");a.addClass(`claude-tool-${i.category}`);let o=n||`tool-${Date.now()}`;a.dataset.toolId=o;let l=a.createSpan({cls:"claude-tool-icon"});l.textContent=i.icon,l.style.setProperty("--tool-color",i.color);let r=a.createSpan({cls:"claude-tool-spinner"});(0,k.setIcon)(r,"loader");let c=a.createEl("details",{cls:"claude-tool-details"}),p=c.createEl("summary"),u=p.createSpan({cls:"claude-tool-name-badge"});u.textContent=e,u.style.setProperty("--tool-color",i.color);let f=p.createSpan({cls:"claude-tool-summary-text"});f.textContent=this.getToolSummary(e,s);let h=c.createEl("pre",{cls:"claude-tool-input"});if(h.textContent=JSON.stringify(s,null,2),e==="Edit"&&s.old_string&&s.new_string){let v=c.createDiv("claude-tool-diff");this.renderDiff(v,s.old_string,s.new_string)}this.activeToolCalls.set(o,{id:o,name:e,input:s,startTime:Date.now(),element:a}),this.messagesEl.scrollTop=this.messagesEl.scrollHeight}handleToolResult(e){let s=e.id;if(!s)return;let n=this.activeToolCalls.get(s);if(n){let i=n.element;i.removeClass("claude-tool-running"),i.addClass(e.is_error?"claude-tool-error":"claude-tool-complete");let a=i.querySelector(".claude-tool-spinner");a&&a.remove();let o=Date.now()-n.startTime,l=i.createSpan({cls:"claude-tool-duration"});l.textContent=o>1e3?`${(o/1e3).toFixed(1)}s`:`${o}ms`;let r=i.createSpan({cls:"claude-tool-result-indicator"});if(r.textContent=e.is_error?"\u2717":"\u2713",e.is_error&&e.output){let c=i.querySelector(".claude-tool-details");if(c){let p=c.createDiv("claude-tool-error-output");p.textContent=typeof e.output=="string"?e.output:JSON.stringify(e.output)}}this.activeToolCalls.delete(s)}}renderDiff(e,s,n){e.empty(),e.createDiv("claude-diff-header").createSpan({text:"Changes",cls:"claude-diff-title"});let a=e.createDiv("claude-diff-content"),o=s.split(`
`),l=n.split(`
`);if(o.length>0&&s.trim()){let r=a.createDiv("claude-diff-removed");r.createSpan({text:"\u2212",cls:"claude-diff-marker"});let c=r.createEl("code");c.textContent=s}if(l.length>0&&n.trim()){let r=a.createDiv("claude-diff-added");r.createSpan({text:"+",cls:"claude-diff-marker"});let c=r.createEl("code");c.textContent=n}}getToolSummary(e,s){var a,o,l;let n=s.file_path,i=(n==null?void 0:n.split("/").pop())||"file";switch(e){case"Read":return i;case"Edit":return i;case"Write":return i;case"Glob":return`${s.pattern||"*"}`;case"Grep":return`"${((a=s.pattern)==null?void 0:a.substring(0,30))||"..."}"`;case"Bash":{let c=s.command||"";return c.substring(0,50)+(c.length>50?"...":"")}case"WebFetch":try{return new URL(s.url).hostname}catch(c){return"URL"}case"WebSearch":return`"${((o=s.query)==null?void 0:o.substring(0,30))||"..."}"`;case"Task":return((l=s.description)==null?void 0:l.substring(0,40))||"subtask";case"TodoWrite":let r=s.todos;return r?`${r.length} items`:"todos";default:return""}}appendThinking(){let e=this.messagesEl.createDiv("claude-thinking");return e.createSpan({text:"\u{1F9E0}",cls:"claude-thinking-icon"}),e.createSpan({text:"Thinking...",cls:"claude-thinking-text"}),this.messagesEl.scrollTop=this.messagesEl.scrollHeight,e}appendThinkingContent(e){let n=this.messagesEl.createDiv("claude-thinking-block").createEl("details",{cls:"claude-thinking-details"}),i=n.createEl("summary",{cls:"claude-thinking-summary"});i.createSpan({text:"\u{1F9E0}",cls:"claude-thinking-icon"});let a=e.split(`
`)[0].substring(0,50);i.createSpan({text:a+(e.length>50?"...":""),cls:"claude-thinking-preview"});let o=n.createDiv("claude-thinking-content");o.textContent=e,this.messagesEl.scrollTop=this.messagesEl.scrollHeight}removeThinking(){let e=this.messagesEl.querySelector(".claude-thinking");e&&e.remove()}appendQueuedIndicator(){let e=this.messagesEl.createDiv("claude-queued-indicator");e.createSpan({text:"\u23F3",cls:"claude-queued-icon"}),e.createSpan({text:"Queued - will send when current task completes",cls:"claude-queued-text"}),this.messagesEl.scrollTop=this.messagesEl.scrollHeight}removeQueuedIndicator(){let e=this.messagesEl.querySelector(".claude-queued-indicator");e&&e.remove()}renderMessages(e){this.messagesEl.empty(),e.forEach(s=>this.appendMessage(s))}setLoadingState(e){this.skillSelectEl.disabled=e,e?(this.sendBtn.textContent="Reply",this.sendBtn.removeClass("claude-btn-primary"),this.sendBtn.addClass("claude-btn-secondary"),this.abortBtn.removeClass("claude-hidden"),this.inputEl.placeholder="Type to respond to Claude..."):(this.sendBtn.textContent="Send",this.sendBtn.addClass("claude-btn-primary"),this.sendBtn.removeClass("claude-btn-secondary"),this.abortBtn.addClass("claude-hidden"),this.inputEl.placeholder="Ask Claude anything...")}abortRequest(){this.plugin.cliService.abort(),this.setLoadingState(!1)}showError(e){let s=this.messagesEl.createDiv("claude-error");if(e.includes("context")||e.includes("token")||e.includes("too long")||e.includes("max_tokens")||e.includes("length_exceeded")){let i=s.createDiv({cls:"claude-error-content"});i.createEl("strong",{text:"Context limit reached"}),i.createEl("p",{text:"The conversation has grown too long. Start a new chat to continue."}),s.createEl("button",{text:"Start new chat",cls:"claude-btn claude-btn-secondary claude-btn-small"}).addEventListener("click",()=>{this.startNewSession(),s.remove()})}else s.textContent=`Error: ${e}`;this.messagesEl.scrollTop=this.messagesEl.scrollHeight}startNewSession(){let e=this.plugin.sessionManager.createSession();this.currentSessionId=e.id,this.messagesEl.empty(),this.updateMessageCount()}loadSession(e){let s=this.plugin.sessionManager.getSession(e);s&&(this.currentSessionId=e,this.plugin.sessionManager.setActiveSession(e),this.renderMessages(s.messages),this.updateMessageCount())}createContextToggle(e){let s=e.createDiv("claude-context-toggle"),n=s.createEl("button",{cls:`claude-context-btn ${this.includeFileContext?"active":""}`,attr:{"aria-label":"Toggle file context"}}),i=s.createEl("button",{cls:`claude-context-btn ${this.includeWebContext?"active":""}`,attr:{"aria-label":"Toggle web context"}}),a=()=>{let l=this.plugin.app.workspace.getActiveFile();n.empty(),n.createSpan({text:"\u{1F4C4}",cls:"claude-context-icon"}),this.includeFileContext&&l?n.createSpan({text:l.basename,cls:"claude-context-name"}):n.createSpan({text:"No page",cls:"claude-context-name claude-context-off"}),n.toggleClass("active",this.includeFileContext)},o=async()=>{let l=await this.plugin.contextProvider.getWebViewerContext();if(i.empty(),i.createSpan({text:"\u{1F310}",cls:"claude-context-icon"}),this.includeWebContext&&l){let r=l.title&&l.title.length>20?l.title.substring(0,20)+"...":l.title||"Web page";i.createSpan({text:r,cls:"claude-context-name"})}else i.createSpan({text:"No web",cls:"claude-context-name claude-context-off"});i.toggleClass("active",this.includeWebContext)};n.addEventListener("click",()=>{this.includeFileContext=!this.includeFileContext,a()}),i.addEventListener("click",()=>{this.includeWebContext=!this.includeWebContext,o()}),this.registerEvent(this.plugin.app.workspace.on("active-leaf-change",()=>{a(),o()})),a(),o()}setInitialPrompt(e){this.inputEl.value=e,this.inputEl.focus()}generateId(){return`msg-${Date.now()}-${Math.random().toString(36).slice(2,11)}`}async onClose(){this.plugin.cliService.removeAllListeners()}};var T=require("obsidian");function G(d){d.registerMarkdownCodeBlockProcessor("claude-chat",async(t,e,s)=>{await new N(d,t,e,s).render()})}var N=class{constructor(t,e,s,n){this.plugin=t,this.source=e,this.el=s,this.ctx=n,this.state=this.parseSource(e)}parseSource(t){try{if(t.trim()){let e=JSON.parse(t);return{messages:e.messages||[],sessionId:e.sessionId}}}catch(e){if(t.trim())return{messages:[{id:"initial",role:"user",content:t.trim(),timestamp:Date.now()}]}}return{messages:[]}}async render(){this.el.empty(),this.el.addClass("claude-inline-chat"),this.el.createDiv("claude-inline-header").createSpan({text:"Claude chat",cls:"claude-inline-title"}),this.messagesEl=this.el.createDiv("claude-inline-messages"),this.renderMessages(),this.createInputArea(),this.state.messages.length===1&&this.state.messages[0].role==="user"&&!this.state.sessionId&&await this.sendInitialPrompt()}createInputArea(){let t=this.el.createDiv("claude-inline-input-wrapper");this.inputEl=t.createEl("input",{type:"text",placeholder:"Continue conversation...",cls:"claude-inline-input"}),this.inputEl.addEventListener("keydown",async s=>{s.key==="Enter"&&await this.sendMessage()}),t.createEl("button",{text:"Send",cls:"claude-btn claude-btn-small"}).addEventListener("click",()=>void this.sendMessage())}renderMessages(){this.messagesEl.empty();for(let t of this.state.messages){let s=this.messagesEl.createDiv({cls:`claude-inline-message claude-inline-${t.role}`}).createDiv("claude-inline-content");T.MarkdownRenderer.render(this.plugin.app,t.content,s,this.ctx.sourcePath,this.plugin)}}async sendInitialPrompt(){let t=this.state.messages[0].content;await this.executeAndUpdate(t)}async sendMessage(){let t=this.inputEl.value.trim();t&&(this.state.messages.push({id:`msg-${Date.now()}`,role:"user",content:t,timestamp:Date.now()}),this.renderMessages(),this.inputEl.value="",await this.executeAndUpdate(t))}async executeAndUpdate(t){let e=this.messagesEl.createDiv("claude-inline-loading");e.textContent="Claude is thinking...";try{let s=this.ctx.sourcePath,n=this.plugin.app.vault.getAbstractFileByPath(s),i="";if(n instanceof T.TFile){let o=await this.plugin.app.vault.cachedRead(n);i=`Current note (${s}):
${o}

`}let a=await this.plugin.cliService.execute({prompt:i+t,sessionId:this.state.sessionId});a.sessionId&&(this.state.sessionId=a.sessionId),a.finalContent&&this.state.messages.push({id:`msg-${Date.now()}`,role:"assistant",content:a.finalContent,timestamp:Date.now()}),await this.persistState()}catch(s){this.state.messages.push({id:`msg-${Date.now()}`,role:"assistant",content:`Error: ${s.message}`,timestamp:Date.now()})}e.remove(),this.renderMessages()}async persistState(){let t=this.plugin.app.vault.getAbstractFileByPath(this.ctx.sourcePath);if(!(t instanceof T.TFile))return;let e=await this.plugin.app.vault.read(t),s=JSON.stringify({sessionId:this.state.sessionId,messages:this.state.messages},null,2),n=/```claude-chat\n[\s\S]*?\n```/,i=e.replace(n,`\`\`\`claude-chat
${s}
\`\`\``);await this.plugin.app.vault.modify(t,i)}};var g=require("obsidian"),j=require("child_process"),K=require("util"),W=(0,K.promisify)(j.exec);function z(){let d=process.env.PATH||"";if(g.Platform.isMacOS)return`/opt/homebrew/bin:/usr/local/bin:${d}`;if(g.Platform.isLinux)return`/usr/local/bin:${process.env.HOME||""}/.local/bin:${d}`;if(g.Platform.isWin){let t=process.env.APPDATA||"",e=process.env.LOCALAPPDATA||"";return`${t}\\npm;${e}\\npm;${d}`}return d}var le=[/[;&|`$(){}[\]<>]/,/\.\./,/^https?:/i];function ce(d){if(!d||d.trim().length===0)return{valid:!1,reason:"Path cannot be empty"};let t=d.trim();for(let s of le)if(s.test(t))return{valid:!1,reason:"Path contains invalid characters"};return/^[a-zA-Z0-9_.~/-]+$/.test(t)?{valid:!0}:{valid:!1,reason:"Path contains invalid characters"}}var A=class extends g.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new g.Setting(t).setName("Claude Code settings").setHeading(),this.renderConnectionStatus(t),new g.Setting(t).setName("CLI configuration").setHeading(),new g.Setting(t).setName("Claude CLI path").setDesc('Path to the Claude CLI executable. Leave as "claude" to use PATH, or specify full path.').addText(n=>n.setPlaceholder("claude").setValue(this.plugin.settings.claudePath).onChange(async i=>{let a=i||"claude",o=ce(a);if(!o.valid){new g.Notice(`Invalid path: ${o.reason}`);return}this.plugin.settings.claudePath=a,await this.plugin.saveSettings()})).addButton(n=>n.setButtonText("Auto-detect").onClick(async()=>{let i=await this.detectClaudePath();i?(this.plugin.settings.claudePath=i,await this.plugin.saveSettings(),this.display(),new g.Notice(`Claude CLI found: ${i}`)):new g.Notice("Could not auto-detect Claude CLI. Please install it first.")})),new g.Setting(t).setName("Default allowed tools").setDesc("Comma-separated list of tools to auto-approve").addText(n=>n.setPlaceholder("Read,Glob,Grep").setValue(this.plugin.settings.defaultAllowedTools.join(",")).onChange(async i=>{this.plugin.settings.defaultAllowedTools=i.split(",").map(a=>a.trim()).filter(a=>a),await this.plugin.saveSettings()})),new g.Setting(t).setName("Max turns").setDesc("Maximum agentic turns per request").addSlider(n=>n.setLimits(1,50,1).setValue(this.plugin.settings.maxTurns).setDynamicTooltip().onChange(async i=>{this.plugin.settings.maxTurns=i,await this.plugin.saveSettings()})),new g.Setting(t).setName("Skills configuration").setHeading(),new g.Setting(t).setName("Skills folder").setDesc("Path to folder containing custom skills (relative to vault root). Each skill should be a folder with a SKILL.md file.").addText(n=>n.setPlaceholder(".claude/skills").setValue(this.plugin.settings.skillsFolder).onChange(async i=>{this.plugin.settings.skillsFolder=i||".claude/skills",await this.plugin.saveSettings(),await this.plugin.skillLoader.loadSkills()}));let s=t.createDiv({cls:"setting-item-description claude-skills-tip"}).createEl("small");s.createEl("strong",{text:"Tip: "}),s.appendText("Use the built-in "),s.createEl("code",{text:"/skill-creator"}),s.appendText(" command to create new skills. Skills extend Claude's capabilities with specialized workflows and knowledge."),new g.Setting(t).setName("Context settings").setHeading(),new g.Setting(t).setName("Include current note").setDesc("Automatically include the active note as context").addToggle(n=>n.setValue(this.plugin.settings.includeCurrentNote).onChange(async i=>{this.plugin.settings.includeCurrentNote=i,await this.plugin.saveSettings()})),new g.Setting(t).setName("Max context files").setDesc("Maximum number of files to include as context").addSlider(n=>n.setLimits(1,50,1).setValue(this.plugin.settings.maxContextFiles).setDynamicTooltip().onChange(async i=>{this.plugin.settings.maxContextFiles=i,await this.plugin.saveSettings()})),new g.Setting(t).setName("Max context length").setDesc("Maximum total characters for context").addText(n=>n.setValue(this.plugin.settings.maxContextLength.toString()).onChange(async i=>{let a=parseInt(i);!isNaN(a)&&a>0&&(this.plugin.settings.maxContextLength=a,await this.plugin.saveSettings())})),new g.Setting(t).setName("Excluded folders").setDesc("Comma-separated list of folders to exclude from context").addText(n=>n.setPlaceholder(".obsidian,.claude-sessions").setValue(this.plugin.settings.excludeFolders.join(",")).onChange(async i=>{this.plugin.settings.excludeFolders=i.split(",").map(a=>a.trim()).filter(a=>a),await this.plugin.saveSettings()})),new g.Setting(t).setName("UI preferences").setHeading(),new g.Setting(t).setName("Show tool calls").setDesc("Display tool usage in the chat interface").addToggle(n=>n.setValue(this.plugin.settings.showToolCalls).onChange(async i=>{this.plugin.settings.showToolCalls=i,await this.plugin.saveSettings()})),new g.Setting(t).setName("Stream responses").setDesc("Show responses as they stream in").addToggle(n=>n.setValue(this.plugin.settings.streamResponses).onChange(async i=>{this.plugin.settings.streamResponses=i,await this.plugin.saveSettings()})),new g.Setting(t).setName("Default panel position").setDesc("Where to open the chat panel").addDropdown(n=>n.addOption("left","Left").addOption("right","Right").setValue(this.plugin.settings.defaultPanelPosition).onChange(async i=>{this.plugin.settings.defaultPanelPosition=i,await this.plugin.saveSettings()})),new g.Setting(t).setName("Session management").setHeading(),new g.Setting(t).setName("Auto-save sessions").setDesc("Automatically save conversations").addToggle(n=>n.setValue(this.plugin.settings.autoSaveSessions).onChange(async i=>{this.plugin.settings.autoSaveSessions=i,await this.plugin.saveSettings()})),new g.Setting(t).setName("Session storage path").setDesc("Folder path for storing session files").addText(n=>n.setPlaceholder(".claude-sessions").setValue(this.plugin.settings.sessionStoragePath).onChange(async i=>{this.plugin.settings.sessionStoragePath=i||".claude-sessions",await this.plugin.saveSettings()})),new g.Setting(t).setName("Max session history").setDesc("Number of sessions to retain").addSlider(n=>n.setLimits(10,200,10).setValue(this.plugin.settings.maxSessionHistory).setDynamicTooltip().onChange(async i=>{this.plugin.settings.maxSessionHistory=i,await this.plugin.saveSettings()}))}async renderConnectionStatus(t){let e=t.createDiv({cls:"claude-connection-status"}),n=e.createDiv().createSpan({cls:"claude-status-loading"});n.textContent="Checking Claude CLI connection...";let i=await this.checkClaudeConnection();if(e.empty(),i){e.addClass("connected");let a=e.createDiv({cls:"claude-status-wrapper"}),o=a.createSpan({cls:"claude-status-icon"});o.textContent="\u2705";let l=a.createDiv();l.createEl("strong",{text:"Claude CLI connected"});let r=l.createDiv({cls:"claude-status-path"});r.textContent=`Path: ${this.plugin.settings.claudePath}`}else{e.addClass("disconnected");let a=e.createDiv({cls:"claude-setup-content"}),o=a.createDiv({cls:"claude-setup-header"}),l=o.createSpan({cls:"claude-status-icon"});l.textContent="\u26A0\uFE0F";let r=o.createDiv();r.createEl("strong",{text:"Setup required"});let c=r.createDiv({cls:"claude-setup-subtext"});c.textContent="Claude Code CLI needs to be installed";let p=a.createDiv({cls:"claude-setup-steps"});p.createEl("strong",{text:"Setup steps:"});let u=p.createEl("ol"),f=u.createEl("li");f.appendText("Install ");let h=f.createEl("a",{text:"Node.js",href:"https://nodejs.org",cls:"claude-setup-link"});f.appendText(" (if not already installed)");let v=u.createEl("li");v.appendText("Open Terminal and run:"),v.createEl("br"),v.createEl("code",{text:"npm install -g @anthropic-ai/claude-code",cls:"claude-setup-code"});let C=u.createEl("li");C.appendText("Run "),C.createEl("code",{text:"claude",cls:"claude-setup-code"}),C.appendText(" to authenticate with your Anthropic account");let m=u.createEl("li");m.textContent='Click "Auto-detect" below or restart Obsidian';let S=a.createDiv({cls:"claude-setup-buttons"});S.createEl("button",{text:"\u{1F4D6} Installation guide",cls:"mod-cta claude-setup-btn"}).addEventListener("click",()=>{window.open("https://docs.anthropic.com/en/docs/claude-code","_blank")}),S.createEl("button",{text:"\u{1F504} Check again",cls:"claude-setup-btn"}).addEventListener("click",()=>{this.display()})}}async checkClaudeConnection(){try{let t=this.plugin.settings.claudePath,{stdout:e}=await W(`"${t}" --version`,{timeout:5e3,env:{...process.env,PATH:z()}});return e.includes("claude")||e.length>0}catch(t){return!1}}async detectClaudePath(){let t=["claude"];if(g.Platform.isMacOS)t.push("/opt/homebrew/bin/claude","/usr/local/bin/claude");else if(g.Platform.isLinux){let e=process.env.HOME||"";t.push("/usr/local/bin/claude","/usr/bin/claude",`${e}/.local/bin/claude`,`${e}/.npm-global/bin/claude`)}else if(g.Platform.isWin){let e=process.env.APPDATA||"",s=process.env.LOCALAPPDATA||"";t.push(`${e}\\npm\\claude.cmd`,`${s}\\npm\\claude.cmd`,`${e}\\npm\\claude`,`${s}\\npm\\claude`)}try{let e=g.Platform.isWin?"where claude":"which claude",{stdout:s}=await W(e,{timeout:3e3}),n=s.trim().split(`
`)[0];n&&!t.includes(n)&&t.unshift(n)}catch(e){}for(let e of t)try{return await W(`"${e}" --version`,{timeout:3e3,env:{...process.env,PATH:z()}}),e}catch(s){continue}return null}};var Q=require("child_process"),b=require("obsidian");var F=class{constructor(){this.activeToolCalls=new Map}parseLine(t){let e=t.trim();if(!e)return null;try{let s=JSON.parse(e);return console.debug("[MessageParser] Raw message:",s.type,s.subtype||""),this.normalizeMessage(s)}catch(s){return null}}normalizeMessage(t){var n,i;let e=[],s={type:t.type,session_id:t.session_id};if(t.type==="assistant"&&((n=t.message)!=null&&n.content)){for(let a of t.message.content)a.type==="thinking"&&a.thinking?e.push({type:"thinking",session_id:t.session_id,content:a.thinking}):a.type==="text"&&a.text?e.push({...s,content:a.text,role:"assistant"}):a.type==="tool_use"&&(a.id&&a.name&&this.activeToolCalls.set(a.id,{name:a.name,input:a.input||{}}),e.push({type:"tool_use",id:a.id,session_id:t.session_id,name:a.name,input:a.input}));return e.length===0&&e.push(s),e}if(t.type==="user"&&((i=t.message)!=null&&i.content)){for(let a of t.message.content)if(a.type==="tool_result"&&a.tool_use_id){let o=this.activeToolCalls.get(a.tool_use_id);e.push({type:"tool_result",id:a.tool_use_id,session_id:t.session_id,name:o==null?void 0:o.name,input:o==null?void 0:o.input,output:a.content,is_error:t.is_error}),this.activeToolCalls.delete(a.tool_use_id)}if(e.length>0)return e}return t.type==="result"&&t.result&&(s.content=t.result),t.type==="system"&&t.subtype==="init"&&(s.subtype="init"),t.type==="tool_use"&&(s.name=t.name||t.tool_name,s.input=t.input),e.push(s),e}reset(){this.activeToolCalls.clear()}};function de(){let d=process.env.PATH||"";if(b.Platform.isMacOS)return`/opt/homebrew/bin:/usr/local/bin:${d}`;if(b.Platform.isLinux)return`/usr/local/bin:${process.env.HOME||""}/.local/bin:${d}`;if(b.Platform.isWin){let t=process.env.APPDATA||"",e=process.env.LOCALAPPDATA||"";return`${t}\\npm;${e}\\npm;${d}`}return d}var R=class{constructor(t){this.activeProcess=null;this.listeners=new Map;this.queuedInput=null;this.plugin=t,this.parser=new F}on(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}off(t,e){if(!e)this.listeners.delete(t);else{let s=this.listeners.get(t);if(s){let n=s.indexOf(e);n>-1&&s.splice(n,1)}}}emit(t,e){let s=this.listeners.get(t);s&&s.forEach(n=>n(e))}removeAllListeners(){this.listeners.clear()}async execute(t){let e=this.buildArgs(t),s=[],n,i="";return new Promise((a,o)=>{var f,h,v;let l=this.plugin.settings.claudePath,r="";this.plugin.app.vault.adapter instanceof b.FileSystemAdapter&&(r=this.plugin.app.vault.adapter.getBasePath()),console.debug("[Claude Plugin] Spawning:",l,e),this.activeProcess=(0,Q.spawn)(l,e,{cwd:r||void 0,env:{...process.env,PATH:de(),CI:"true",TERM:"dumb"},stdio:["pipe","pipe","pipe"]}),(f=this.activeProcess.stdin)==null||f.end();let c="",p=setTimeout(()=>{console.debug("[Claude Plugin] Process timeout - killing"),this.activeProcess&&this.activeProcess.kill("SIGTERM")},12e4);(h=this.activeProcess.stdout)==null||h.on("data",C=>{c+=C.toString();let m=c.split(`
`);c=m.pop()||"";for(let S of m)if(S.trim())try{let x=this.parser.parseLine(S);if(x)for(let y of x){let X=typeof y.content=="string"?y.content.substring(0,50):"";if(console.debug("[Claude Plugin] Parsed message:",y.type,y.name||"",X),s.push(y),y.session_id&&(n=y.session_id),this.emit("message",y),y.type==="assistant"&&y.content){let E=typeof y.content=="string"?y.content:"";i=E,this.emit("partial",E)}if(y.type==="result"&&y.content){let E=typeof y.content=="string"?y.content:"";i=E,this.emit("partial",E)}}}catch(x){console.error("[Claude Plugin] Failed to parse:",x,S)}});let u="";(v=this.activeProcess.stderr)==null||v.on("data",C=>{u+=C.toString(),console.debug("[Claude Plugin] stderr:",C.toString())}),this.activeProcess.on("close",C=>{if(clearTimeout(p),console.debug("[Claude Plugin] Process closed with code:",C),this.activeProcess=null,c.trim())try{let m=this.parser.parseLine(c);if(m)for(let S of m)s.push(S),S.type==="result"&&S.content&&(i=typeof S.content=="string"?S.content:"",this.emit("partial",i))}catch(m){console.error("[Claude Plugin] Failed to parse final buffer:",m)}a(C===0||i?{success:!0,sessionId:n,messages:s,finalContent:i}:{success:!1,messages:s,error:u||`Process exited with code ${C}`})}),this.activeProcess.on("error",C=>{clearTimeout(p),console.error("[Claude Plugin] Process error:",C),this.activeProcess=null,o(C)})})}buildArgs(t){let e=["-p",t.prompt,"--output-format","stream-json","--verbose"],s=t.allowedTools||this.plugin.settings.defaultAllowedTools;s.length>0&&e.push("--allowedTools",s.join(",")),t.addDirs&&t.addDirs.length>0&&t.addDirs.forEach(i=>{e.push("--add-dir",i)}),t.sessionId&&e.push("--resume",t.sessionId);let n=t.maxTurns||this.plugin.settings.maxTurns;return e.push("--max-turns",n.toString()),t.appendSystemPrompt?e.push("--append-system-prompt",t.appendSystemPrompt):t.systemPrompt&&e.push("--system-prompt",t.systemPrompt),e}abort(){this.activeProcess&&(this.activeProcess.kill("SIGTERM"),this.activeProcess=null)}isRunning(){return this.activeProcess!==null}queueInput(t){return this.isRunning()?(console.debug("[Claude Plugin] Queueing input for follow-up:",t.substring(0,50)),this.queuedInput=t,!0):(console.debug("[Claude Plugin] Cannot queue input - no active process"),!1)}getAndClearQueuedInput(){let t=this.queuedInput;return this.queuedInput=null,t}hasQueuedInput(){return this.queuedInput!==null}};var M=require("obsidian"),$=class{constructor(t){this.plugin=t}async getCurrentNoteContext(){let t=await this.getWebViewerContext();if(t)return t;let e=this.plugin.app.workspace.getActiveFile();if(!e||e.extension!=="md")return null;let s=await this.plugin.app.vault.cachedRead(e);return{type:"file",path:e.path,title:e.basename,content:s}}async getWebViewerContext(){var t,e,s;try{let n=this.plugin.app.workspace.getLeavesOfType("webviewer");if(n.length===0)return null;let i=n[0].view;if(!i||!("contentEl"in i))return null;let o=(t=i.contentEl)==null?void 0:t.querySelector("webview");if(!o)return null;let l=o;if(typeof l.getWebContentsId!="function")return console.debug("[Context Provider] WebView not ready or not an Electron webview"),null;let r=((e=l.getURL)==null?void 0:e.call(l))||"",c=((s=l.getTitle)==null?void 0:s.call(l))||r,p=null;try{p=require("electron").remote}catch(C){return console.debug("[Context Provider] Electron remote module not available"),null}if(!p||!p.webContents)return console.debug("[Context Provider] Electron remote API not available - this feature requires Obsidian desktop"),null;let u=l.getWebContentsId();if(!u)return null;let f=p.webContents.fromId(u);if(!f)return null;let h=await f.executeJavaScript(`
        (function() {
          // Get page title and meta description
          const title = document.title;
          const metaDesc = document.querySelector('meta[name="description"]')?.content || '';

          // Get main text content, excluding scripts and styles
          const clone = document.body.cloneNode(true);
          const scripts = clone.querySelectorAll('script, style, noscript');
          scripts.forEach(el => el.remove());

          const textContent = clone.innerText || clone.textContent || '';

          return {
            title: title,
            description: metaDesc,
            content: textContent.trim()
          };
        })();
      `,!0);if(!h||!h.content)return null;let v=`# ${h.title}

URL: ${r}

${h.description?`${h.description}

`:""}${h.content}`;return{type:"webpage",url:r,title:h.title||c,content:v,path:r}}catch(n){return console.debug("[Context Provider] Web viewer context unavailable:",n instanceof Error?n.message:"unknown error"),null}}async searchVault(t,e){let{vault:s,metadataCache:n}=this.plugin.app,i=s.getMarkdownFiles(),a=[],o=this.extractSearchTerms(t),l=this.plugin.settings.excludeFolders;for(let r of i){if(l.some(m=>r.path.startsWith(m)))continue;let c=0,p,u,f=n.getFileCache(r),h=this.parseFrontmatter(f==null?void 0:f.frontmatter);for(let m of o)r.basename.toLowerCase().includes(m)&&(c+=15,u="filename match");if(h.keywords)for(let m of h.keywords)for(let S of o)m.toLowerCase().includes(S)&&(c+=12,u=u||"keyword match");if(h.tags)for(let m of h.tags)for(let S of o)m.toLowerCase().includes(S)&&(c+=10,u=u||"tag match");if(h.summary)for(let m of o)h.summary.toLowerCase().includes(m)&&(c+=8,u=u||"summary match");if(f!=null&&f.headings)for(let m of f.headings)for(let S of o)m.heading.toLowerCase().includes(S)&&(c+=6,u=u||"heading match");let v=await s.cachedRead(r),C=v.toLowerCase();for(let m of o){let S=C.indexOf(m);if(S!==-1){if(c+=4,!p){let x=Math.max(0,S-50),y=Math.min(v.length,S+m.length+100);p=v.substring(x,y)}u=u||"content match"}}(h.status==="active"||h.status==="wip")&&(c+=3),c>0&&a.push({file:r,path:r.path,title:h.title||r.basename,excerpt:p,score:c,relevanceReason:u})}return a.sort((r,c)=>c.score-r.score).slice(0,e||this.plugin.settings.maxContextFiles)}async getRelatedFiles(t,e=1){let{vault:s,metadataCache:n}=this.plugin.app,i=new Set,a=new Set;await(async(r,c)=>{if(c>e||a.has(r.path))return;a.add(r.path);let p=n.getFileCache(r);if(p!=null&&p.links)for(let h of p.links){let v=n.getFirstLinkpathDest(h.link,r.path);v&&v instanceof M.TFile&&i.add(v.path)}let u=this.parseFrontmatter(p==null?void 0:p.frontmatter);if(u.related)for(let h of u.related){let v=h.match(/\[\[([^\]]+)\]\]/),C=v?v[1]:h,m=n.getFirstLinkpathDest(C,r.path);m&&m instanceof M.TFile&&i.add(m.path)}let f=s.getMarkdownFiles();for(let h of f){if(h.path===r.path)continue;let v=n.getFileCache(h);if(v!=null&&v.links)for(let C of v.links){let m=n.getFirstLinkpathDest(C.link,h.path);if(m&&m.path===r.path){i.add(h.path);break}}}})(t,0);let l=[];for(let r of i)if(r!==t.path){let c=s.getAbstractFileByPath(r);c instanceof M.TFile&&l.push(c)}return l}parseFrontmatter(t){return t?{title:t.title,tags:this.normalizeArray(t.tags),keywords:this.normalizeArray(t.keywords),related:this.normalizeArray(t.related),summary:t.summary,type:t.type,status:t.status}:{}}normalizeArray(t){if(t){if(Array.isArray(t))return t.map(String);if(typeof t=="string")return t.split(",").map(e=>e.trim())}}extractSearchTerms(t){let e=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","as","is","was","are","were","been","be","have","has","had","do","does","did","will","would","could","should","may","might","must","can","this","that","these","those","i","you","he","she","it","we","they","what","which","who","when","where","why","how","all","each","every","both","few","more","most","other","some","such","no","not","only","own","same","so","than","too","very","just","about","into","through","during","before","after","above","below","between","under","again","further","then","once","here","there","any","me","my","help","find","show","get","tell","give","please","want","need","look","see"]);return t.toLowerCase().replace(/[^\w\s-]/g," ").split(/\s+/).filter(s=>s.length>2&&!e.has(s))}metadataMatchesQuery(t,e){var s,n;return!!((s=t.tags)!=null&&s.some(i=>i.tag.toLowerCase().includes(e))||(n=t.headings)!=null&&n.some(i=>i.heading.toLowerCase().includes(e)))}async gatherContext(t,e){let s=[],n=new Set,i=0,a=this.plugin.settings.maxContextLength,o=async(r,c)=>{if(n.has(r.path))return!1;let p=await this.plugin.app.vault.cachedRead(r);if(i+p.length>=a)return!1;let u=this.plugin.app.metadataCache.getFileCache(r),f=this.parseFrontmatter(u==null?void 0:u.frontmatter);return s.push({type:"file",path:r.path,title:f.title||r.basename,content:p}),n.add(r.path),i+=p.length,!0};if(this.plugin.settings.includeCurrentNote){let r=this.plugin.app.workspace.getActiveFile();if(r&&r.extension==="md"){await o(r,"active file");let c=await this.getRelatedFiles(r,1);for(let p of c.slice(0,3)){if(i>=a*.5)break;await o(p,"related via wikilink")}}}if(e)for(let r of e)await o(r,"explicitly provided");let l=await this.searchVault(t);for(let r of l)if(!await o(r.file,r.relevanceReason))break;return{files:s,totalLength:i,truncated:i>=a}}formatContextForPrompt(t){return t.length===0?"":`Here is relevant context from the vault:

${t.map(s=>`--- File: ${s.path} ---
${s.content}
--- End File ---`).join(`

`)}

`}async getVaultAwareness(t=!0){let{vault:e}=this.plugin.app,s=e.adapter.basePath||e.getName(),i=e.getRoot().children.filter(l=>!(l instanceof M.TFile)).map(l=>l.name).filter(l=>!l.startsWith(".")).sort(),a=e.getMarkdownFiles().length,o=`You are working in an Obsidian vault located at: ${s}

This vault contains ${a} markdown files organized in these folders:
${i.map(l=>`- ${l}/`).join(`
`)}

To explore the vault, use your tools:
- Use Glob to find files by pattern (e.g., "**/*.md", "Meeting Notes/**/*.md")
- Use Grep to search file contents
- Use Read to read specific files

Do NOT ask me to provide file contents - use your tools to read them directly.`;if(t){let l=this.plugin.app.workspace.getActiveFile();if(l&&l.extension==="md"){let r=this.plugin.app.metadataCache.getFileCache(l),c=this.parseFrontmatter(r==null?void 0:r.frontmatter);o+=`

The user currently has this file open: ${l.path}`,c.title&&(o+=`
  Title: ${c.title}`),c.tags&&c.tags.length>0&&(o+=`
  Tags: ${c.tags.join(", ")}`),c.summary&&(o+=`
  Summary: ${c.summary}`),o+=`
If the user's question seems related to this file, read it with the Read tool.`}}return o+`

`}getCurrentFileReference(){let t=this.plugin.app.workspace.getActiveFile();if(!t||t.extension!=="md")return null;let e=this.plugin.app.metadataCache.getFileCache(t),s=this.parseFrontmatter(e==null?void 0:e.frontmatter);return{path:t.path,title:s.title||t.basename}}};var J=require("obsidian");function ue(d){if(!d||typeof d!="object")return!1;let t=d;if(typeof t.id!="string"||!t.id||!Array.isArray(t.messages)||typeof t.createdAt!="number"||typeof t.updatedAt!="number")return!1;for(let e of t.messages){if(!e||typeof e!="object")return!1;let s=e;if(typeof s.id!="string"||s.role!=="user"&&s.role!=="assistant")return!1}return!0}var B=class{constructor(t){this.sessions=new Map;this.activeSessionId=null;this.plugin=t}async initialize(){await this.ensureStorageFolder(),await this.loadSessions()}async ensureStorageFolder(){let{vault:t}=this.plugin.app,e=this.plugin.settings.sessionStoragePath;await t.adapter.exists(e)||await t.createFolder(e)}async loadSessions(){let{vault:t}=this.plugin.app,e=this.plugin.settings.sessionStoragePath;try{if(!await t.adapter.exists(e)){console.debug("[SessionManager] Session folder does not exist yet");return}let n=await t.adapter.list(e);for(let i of n.files)if(i.endsWith(".json"))try{let a=await t.adapter.read(i),o=JSON.parse(a);if(!ue(o)){console.warn("[SessionManager] Invalid session structure, skipping:",i);continue}this.sessions.set(o.id,o),console.debug("[SessionManager] Loaded session:",o.id)}catch(a){console.error("[SessionManager] Failed to parse session file:",i,a)}console.debug("[SessionManager] Loaded",this.sessions.size,"sessions")}catch(s){console.error("[SessionManager] Failed to load sessions:",s)}}createSession(t){let e=this.generateId(),s={id:e,name:t||`Chat ${new Date().toLocaleDateString()}`,messages:[],context:[],createdAt:Date.now(),updatedAt:Date.now()};return this.sessions.set(e,s),this.activeSessionId=e,s}getSession(t){return this.sessions.get(t)}getActiveSession(){return this.activeSessionId&&this.sessions.get(this.activeSessionId)||null}setActiveSession(t){this.activeSessionId=t}addMessage(t,e){let s=this.sessions.get(t);s&&(s.messages.push(e),s.updatedAt=Date.now(),this.plugin.settings.autoSaveSessions&&this.saveSession(s))}updateLastMessage(t,e){let s=this.sessions.get(t);if(s&&s.messages.length>0){let n=s.messages[s.messages.length-1];n.content=e,n.isStreaming=!0}}finalizeLastMessage(t){let e=this.sessions.get(t);if(e&&e.messages.length>0){let s=e.messages[e.messages.length-1];s.isStreaming=!1,e.updatedAt=Date.now(),this.plugin.settings.autoSaveSessions&&this.saveSession(e)}}async saveSession(t){let{vault:e}=this.plugin.app,s=`${this.plugin.settings.sessionStoragePath}/${t.id}.json`,n=JSON.stringify(t,null,2);try{await e.adapter.exists(s)?await e.adapter.write(s,n):await e.create(s,n)}catch(i){console.error("Failed to save session:",i)}}async saveAllSessions(){for(let t of this.sessions.values())await this.saveSession(t)}getAllSessions(){return Array.from(this.sessions.values()).sort((t,e)=>e.updatedAt-t.updatedAt)}async deleteSession(t){let{vault:e,fileManager:s}=this.plugin.app,n=`${this.plugin.settings.sessionStoragePath}/${t}.json`;this.sessions.delete(t);try{let i=e.getAbstractFileByPath(n);i instanceof J.TFile&&await s.trashFile(i)}catch(i){console.error("[SessionManager] Failed to delete session file:",i)}}setClaudeSessionId(t,e){let s=this.sessions.get(t);s&&(s.claudeSessionId=e)}generateId(){return`session-${Date.now()}-${Math.random().toString(36).slice(2,11)}`}};var Y=require("obsidian"),w=q(require("fs")),L=q(require("path")),pe={id:"skill-creator",name:"Skill Creator",description:"Guide for creating effective skills. Use when you want to create a new skill (or update an existing skill) that extends Claude's capabilities with specialized knowledge, workflows, or tool integrations.",icon:"\u{1F6E0}\uFE0F",isBuiltIn:!0},he=`---
name: skill-creator
description: Guide for creating effective skills. This skill should be used when users want to create a new skill (or update an existing skill) that extends Claude's capabilities with specialized knowledge, workflows, or tool integrations.
---

# Skill Creator

This skill provides guidance for creating effective skills for this Obsidian vault.

## About Skills

Skills are modular, self-contained packages that extend Claude's capabilities by providing specialized knowledge, workflows, and tools. Think of them as "onboarding guides" for specific domains or tasks\u2014they transform Claude from a general-purpose agent into a specialized agent equipped with procedural knowledge.

### What Skills Provide

1. **Specialized workflows** - Multi-step procedures for specific domains
2. **Tool integrations** - Instructions for working with specific file formats or APIs
3. **Domain expertise** - Company-specific knowledge, schemas, business logic
4. **Bundled resources** - Scripts, references, and assets for complex and repetitive tasks

## Skill Structure

Every skill consists of a required SKILL.md file and optional bundled resources:

\`\`\`
skill-name/
\u251C\u2500\u2500 SKILL.md (required)
\u2502   \u251C\u2500\u2500 YAML frontmatter metadata (required)
\u2502   \u2502   \u251C\u2500\u2500 name: (required)
\u2502   \u2502   \u2514\u2500\u2500 description: (required)
\u2502   \u2514\u2500\u2500 Markdown instructions (required)
\u2514\u2500\u2500 Bundled Resources (optional)
    \u251C\u2500\u2500 scripts/          - Executable code (Python/Bash/etc.)
    \u251C\u2500\u2500 references/       - Documentation intended to be loaded into context as needed
    \u2514\u2500\u2500 assets/           - Files used in output (templates, icons, fonts, etc.)
\`\`\`

### SKILL.md Requirements

Every SKILL.md must have:

- **Frontmatter** (YAML): Contains \`name\` and \`description\` fields
  - \`name\`: The skill identifier (hyphen-case, e.g., "my-skill")
  - \`description\`: Clear explanation of what the skill does AND when to use it
- **Body** (Markdown): Instructions and guidance for using the skill

### Bundled Resources

#### scripts/
Executable code (Python/Bash/etc.) for tasks requiring deterministic reliability.
- Include when the same code is being rewritten repeatedly
- Scripts can be executed without loading into context

#### references/
Documentation loaded into context as needed.
- Database schemas, API documentation, domain knowledge
- Keep files under 100 lines when possible, include TOC for longer files

#### assets/
Files used in output (not loaded into context).
- Templates, images, icons, boilerplate code, fonts

## Creating a New Skill

### Step 1: Plan the Skill

Before creating, determine:
1. What specific tasks should this skill handle?
2. What resources (scripts, references, assets) would be helpful?
3. When should Claude automatically recognize to use this skill?

### Step 2: Create the Skill Directory

Create a new folder in the skills directory with this structure:

\`\`\`bash
# In your vault's skills folder (default: .claude/skills/)
mkdir -p my-new-skill
\`\`\`

### Step 3: Create SKILL.md

Create the SKILL.md file with required frontmatter:

\`\`\`yaml
---
name: my-new-skill
description: [Clear description of what the skill does]. Use when [specific scenarios that trigger this skill].
---

# My New Skill

## Overview
[1-2 sentences explaining what this skill enables]

## Usage
[Instructions for how to use the skill]

## [Additional sections as needed]
\`\`\`

### Step 4: Add Resources (Optional)

Add any supporting resources:
- \`scripts/\` - Python/Bash scripts for automation
- \`references/\` - Documentation and guides
- \`assets/\` - Templates and files for output

### Step 5: Test the Skill

After creating the skill:
1. Reload the plugin settings or restart Obsidian
2. The skill should appear in the Mode dropdown
3. Test with relevant prompts to ensure it triggers correctly

## Best Practices

### Writing Good Descriptions

The description is critical - it determines when Claude uses the skill:

**Good:** "Process meeting notes to extract action items, decisions, and key discussion points. Use when reviewing meeting transcripts, summarizing discussions, or creating follow-up task lists."

**Bad:** "Meeting notes skill"

### Keep SKILL.md Concise

- Claude is already very smart - only add context it doesn't have
- Challenge each piece of information: "Does this justify its token cost?"
- Prefer concise examples over verbose explanations
- Target under 500 lines; split into references if longer

### Set Appropriate Degrees of Freedom

- **High freedom**: Text instructions for contextual decisions
- **Medium freedom**: Pseudocode or scripts with parameters
- **Low freedom**: Specific scripts for fragile operations

## Example Skills

### Simple Task Skill
\`\`\`yaml
---
name: code-review
description: Review code for quality, security, and best practices. Use when asked to review PRs, audit code, or suggest improvements.
---

# Code Review

## Review Checklist
1. Security vulnerabilities (OWASP top 10)
2. Performance issues
3. Code style and readability
4. Test coverage
5. Documentation

## Output Format
Provide findings as:
- \u{1F534} Critical issues (must fix)
- \u{1F7E1} Suggestions (should consider)
- \u{1F7E2} Good practices (already doing well)
\`\`\`

### Skill with Scripts
\`\`\`yaml
---
name: data-processor
description: Process and transform data files. Use for CSV manipulation, JSON transformation, or data cleaning tasks.
---

# Data Processor

## Available Scripts

- \`scripts/csv_cleaner.py\` - Remove duplicates and empty rows
- \`scripts/json_transformer.py\` - Transform JSON structure

## Usage
Specify the input file and desired transformation.
\`\`\`
`,ge={"skill-creator":"\u{1F6E0}\uFE0F",tasks:"\u2705",meeting:"\u{1F4DD}",prfaq:"\u{1F4C4}",blog:"\u270D\uFE0F",research:"\u{1F50D}",oneone:"\u{1F464}",project:"\u{1F4CA}",perf:"\u{1F3C6}",audit:"\u{1F5C2}\uFE0F",jira:"\u{1F3AB}",feedback:"\u{1F4AC}",metrics:"\u{1F4C8}",confluence:"\u{1F504}",fullstory:"\u{1F3AC}",changelog:"\u{1F4CB}",competitive:"\u{1F3C1}",scrape:"\u{1F577}\uFE0F"},_=class{constructor(t){this.skills=[];this.plugin=t}async loadSkills(){try{this.skills=[{id:"",name:"General",description:"General assistant",icon:"\u{1F4AC}"}],this.skills.push(pe);let t=await this.loadSkillsFromFolder();return t.sort((e,s)=>e.name.localeCompare(s.name)),this.skills.push(...t),console.debug("[Skill Loader] Loaded",this.skills.length-1,"skills (1 built-in +",t.length,"from folder)"),this.skills}catch(t){return console.error("[Skill Loader] Error loading skills:",t),this.skills}}async loadSkillsFromFolder(){let t=[];try{let e="";if(this.plugin.app.vault.adapter instanceof Y.FileSystemAdapter&&(e=this.plugin.app.vault.adapter.getBasePath()),!e)return console.debug("[Skill Loader] Could not determine vault path"),t;let s=this.plugin.settings.skillsFolder,n=L.join(e,s);if(console.debug("[Skill Loader] Looking for skills in:",n),!w.existsSync(n))return console.debug("[Skill Loader] Skills folder does not exist:",n),t;let i=w.readdirSync(n,{withFileTypes:!0});for(let a of i){if(!a.isDirectory()||a.name==="skill-creator")continue;let o=L.join(n,a.name),l=L.join(o,"SKILL.md");if(!w.existsSync(l)){console.debug("[Skill Loader] No SKILL.md found in:",o);continue}try{let r=w.readFileSync(l,"utf-8"),c=this.parseSkillMd(r,a.name);c&&(c.skillPath=o,t.push(c),console.debug("[Skill Loader] Loaded skill:",c.id))}catch(r){console.error("[Skill Loader] Error parsing skill:",a.name,r)}}}catch(e){console.error("[Skill Loader] Error reading skills folder:",e)}return t}parseSkillMd(t,e){let s=e,n="",i=t.match(/^---\n([\s\S]*?)\n---/);if(i){let o=i[1],l=o.match(/^name:\s*(.+)$/m);l&&(s=l[1].trim());let r=o.match(/^description:\s*(.+)$/m);r&&(n=r[1].trim())}if(!n){let o=t.split(`
`).filter(l=>l.trim());if(i){let l=t.indexOf("---",4);if(l>0){let r=t.slice(l+3).trim(),c=r.split(`
`).filter(u=>u.trim()),p=r.match(/^#\s+(.+)$/m);for(let u of c)if(!u.startsWith("#")&&u.trim().length>10){n=u.trim().substring(0,200);break}}}else{for(let r of o)if(!r.startsWith("#")&&r.trim().length>10){n=r.trim().substring(0,200);break}let l=t.match(/^#\s+(.+)$/m)}}n||(n=`${this.formatSkillName(s)} skill`,console.debug("[Skill Loader] Using fallback description for:",s));let a=ge[s]||"\u26A1";return console.debug("[Skill Loader] Parsed skill:",s,"-",n.substring(0,50)),{id:s,name:this.formatSkillName(s),description:n,icon:a}}formatSkillName(t){let e={"skill-creator":"Skill Creator",tasks:"Task Management",meeting:"Meeting Notes",prfaq:"PRFAQ",blog:"Blog/Content",research:"Research",oneone:"1:1 & Performance",project:"Project Tracker",perf:"Performance",audit:"Vault Audit",jira:"Jira Tickets",feedback:"Feedback",metrics:"Metrics",confluence:"Confluence",fullstory:"FullStory",changelog:"Changelog",competitive:"Competitive Intel",scrape:"Site Scraper"};return e[t]?e[t]:t.split("-").map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" ")}getSkills(){return this.skills}async getSkillContent(t){if(t==="skill-creator")return he;let e=this.skills.find(s=>s.id===t);if(!e||!e.skillPath)return null;try{let s=L.join(e.skillPath,"SKILL.md");if(w.existsSync(s))return w.readFileSync(s,"utf-8")}catch(s){console.error("[Skill Loader] Error reading skill content:",t,s)}return null}getSkillPath(t){let e=this.skills.find(s=>s.id===t);return(e==null?void 0:e.skillPath)||null}};var H=class extends Z.Plugin{async onload(){await this.loadSettings(),this.cliService=new R(this),this.contextProvider=new $(this),this.sessionManager=new B(this),this.skillLoader=new _(this),await this.sessionManager.initialize(),await this.skillLoader.loadSkills(),this.registerView(P,t=>new I(t,this)),G(this),this.addRibbonIcon("message-circle","Open Claude chat",()=>{this.activateChatPanel()}),this.addCommand({id:"open-claude-chat",name:"Open Claude chat panel",callback:()=>void this.activateChatPanel()}),this.addCommand({id:"ask-claude-about-selection",name:"Ask Claude about selection",editorCallback:t=>{let e=t.getSelection();e&&this.activateChatPanel(e)}}),this.addCommand({id:"confluence-push",name:"Confluence: Push to Confluence",callback:()=>{this.activateChatPanel("/confluence push")}}),this.addCommand({id:"confluence-pull",name:"Confluence: Pull from Confluence",callback:()=>{this.activateChatPanel("/confluence pull")}}),this.addCommand({id:"confluence-status",name:"Confluence: Check sync status",callback:()=>{this.activateChatPanel("/confluence status")}}),this.addCommand({id:"confluence-list",name:"Confluence: List all synced files",callback:()=>{this.activateChatPanel("/confluence list")}}),this.addSettingTab(new A(this.app,this)),this.app.workspace.onLayoutReady(()=>{this.activateChatPanel()})}onunload(){this.sessionManager.saveAllSessions()}async loadSettings(){this.settings=Object.assign({},V,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async activateChatPanel(t){let{workspace:e}=this.app,s=e.getLeavesOfType(P)[0];s||(s=this.settings.defaultPanelPosition==="left"?e.getLeftLeaf(!1):e.getRightLeaf(!1),await s.setViewState({type:P,active:!0})),e.revealLeaf(s),t&&s.view.setInitialPrompt(t)}};
